@Test public void testVisibilityLabelsWithDeleteColumnsWithPutsReAppearing() throws Exception {
  TableName tableName=createTable(5);
  try (Table table=TEST_UTIL.getConnection().getTable(tableName)){
    Put put=new Put(Bytes.toBytes("row1"));
    put.addColumn(fam,qual,value);
    put.setCellVisibility(new CellVisibility(CONFIDENTIAL));
    table.put(put);
    put=new Put(Bytes.toBytes("row1"));
    put.addColumn(fam,qual,value);
    put.setCellVisibility(new CellVisibility(SECRET));
    table.put(put);
    TEST_UTIL.getAdmin().flush(tableName);
    PrivilegedExceptionAction<Void> actiona=new PrivilegedExceptionAction<Void>(){
      @Override public Void run() throws Exception {
        try (Connection connection=ConnectionFactory.createConnection(conf);Table table=connection.getTable(tableName)){
          Delete d=new Delete(row1);
          d.setCellVisibility(new CellVisibility(CONFIDENTIAL));
          d.addColumns(fam,qual);
          table.delete(d);
        }
 catch (        Throwable t) {
          throw new IOException(t);
        }
        return null;
      }
    }
;
    SUPERUSER.runAs(actiona);
    Scan s=new Scan();
    s.readVersions(5);
    s.setAuthorizations(new Authorizations(SECRET));
    ResultScanner scanner=table.getScanner(s);
    Result[] next=scanner.next(3);
    assertEquals(1,next.length);
    put=new Put(Bytes.toBytes("row1"));
    put.addColumn(fam,qual,value1);
    put.setCellVisibility(new CellVisibility(CONFIDENTIAL));
    table.put(put);
    actiona=new PrivilegedExceptionAction<Void>(){
      @Override public Void run() throws Exception {
        try (Connection connection=ConnectionFactory.createConnection(conf);Table table=connection.getTable(tableName)){
          Delete d=new Delete(row1);
          d.setCellVisibility(new CellVisibility(SECRET));
          d.addColumns(fam,qual);
          table.delete(d);
        }
 catch (        Throwable t) {
          throw new IOException(t);
        }
        return null;
      }
    }
;
    SUPERUSER.runAs(actiona);
    s=new Scan();
    s.readVersions(5);
    s.setAuthorizations(new Authorizations(CONFIDENTIAL));
    scanner=table.getScanner(s);
    next=scanner.next(3);
    assertEquals(1,next.length);
    s=new Scan();
    s.readVersions(5);
    s.setAuthorizations(new Authorizations(SECRET));
    scanner=table.getScanner(s);
    Result[] next1=scanner.next(3);
    assertEquals(0,next1.length);
  }
 }
