@Test public void testSecureWAL() throws Exception {
  TableName tableName=TableName.valueOf(name.getMethodName().replaceAll("[^a-zA-Z0-9]","_"));
  NavigableMap<byte[],Integer> scopes=new TreeMap<>(Bytes.BYTES_COMPARATOR);
  scopes.put(tableName.getName(),0);
  RegionInfo regionInfo=RegionInfoBuilder.newBuilder(tableName).build();
  final int total=10;
  final byte[] row=Bytes.toBytes("row");
  final byte[] family=Bytes.toBytes("family");
  final byte[] value=Bytes.toBytes("Test value");
  FileSystem fs=TEST_UTIL.getDFSCluster().getFileSystem();
  final WALFactory wals=new WALFactory(TEST_UTIL.getConfiguration(),tableName.getNameAsString());
  final WAL wal=wals.getWAL(regionInfo);
  MultiVersionConcurrencyControl mvcc=new MultiVersionConcurrencyControl();
  for (int i=0; i < total; i++) {
    WALEdit kvs=new WALEdit();
    kvs.add(new KeyValue(row,family,Bytes.toBytes(i),value));
    wal.append(regionInfo,new WALKeyImpl(regionInfo.getEncodedNameAsBytes(),tableName,System.currentTimeMillis(),mvcc,scopes),kvs,true);
  }
  wal.sync();
  final Path walPath=AbstractFSWALProvider.getCurrentFileName(wal);
  wals.shutdown();
  long length=fs.getFileStatus(walPath).getLen();
  FSDataInputStream in=fs.open(walPath);
  byte[] fileData=new byte[(int)length];
  IOUtils.readFully(in,fileData);
  in.close();
  assertFalse("Cells appear to be plaintext",Bytes.contains(fileData,value));
  WAL.Reader reader=wals.createReader(TEST_UTIL.getTestFileSystem(),walPath);
  int count=0;
  WAL.Entry entry=new WAL.Entry();
  while (reader.next(entry) != null) {
    count++;
    List<Cell> cells=entry.getEdit().getCells();
    assertTrue("Should be one KV per WALEdit",cells.size() == 1);
    for (    Cell cell : cells) {
      assertTrue("Incorrect row",Bytes.equals(cell.getRowArray(),cell.getRowOffset(),cell.getRowLength(),row,0,row.length));
      assertTrue("Incorrect family",Bytes.equals(cell.getFamilyArray(),cell.getFamilyOffset(),cell.getFamilyLength(),family,0,family.length));
      assertTrue("Incorrect value",Bytes.equals(cell.getValueArray(),cell.getValueOffset(),cell.getValueLength(),value,0,value.length));
    }
  }
  assertEquals("Should have read back as many KVs as written",total,count);
  reader.close();
}
