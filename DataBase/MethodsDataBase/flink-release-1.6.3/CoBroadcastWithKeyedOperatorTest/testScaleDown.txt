@Test public void testScaleDown() throws Exception {
  final Set<String> keysToRegister=new HashSet<>();
  keysToRegister.add("test1");
  keysToRegister.add("test2");
  keysToRegister.add("test3");
  final OperatorSubtaskState mergedSnapshot;
  try (TwoInputStreamOperatorTestHarness<String,Integer,String> testHarness1=getInitializedTestHarness(BasicTypeInfo.STRING_TYPE_INFO,new IdentityKeySelector<>(),new TestFunctionWithOutput(keysToRegister),10,3,0);TwoInputStreamOperatorTestHarness<String,Integer,String> testHarness2=getInitializedTestHarness(BasicTypeInfo.STRING_TYPE_INFO,new IdentityKeySelector<>(),new TestFunctionWithOutput(keysToRegister),10,3,1);TwoInputStreamOperatorTestHarness<String,Integer,String> testHarness3=getInitializedTestHarness(BasicTypeInfo.STRING_TYPE_INFO,new IdentityKeySelector<>(),new TestFunctionWithOutput(keysToRegister),10,3,2)){
    testHarness1.processElement2(new StreamRecord<>(3));
    testHarness2.processElement2(new StreamRecord<>(3));
    testHarness3.processElement2(new StreamRecord<>(3));
    mergedSnapshot=AbstractStreamOperatorTestHarness.repackageState(testHarness1.snapshot(0L,0L),testHarness2.snapshot(0L,0L),testHarness3.snapshot(0L,0L));
  }
   final Set<String> expected=new HashSet<>(3);
  expected.add("test1=3");
  expected.add("test2=3");
  expected.add("test3=3");
  try (TwoInputStreamOperatorTestHarness<String,Integer,String> testHarness1=getInitializedTestHarness(BasicTypeInfo.STRING_TYPE_INFO,new IdentityKeySelector<>(),new TestFunctionWithOutput(keysToRegister),10,2,0,mergedSnapshot);TwoInputStreamOperatorTestHarness<String,Integer,String> testHarness2=getInitializedTestHarness(BasicTypeInfo.STRING_TYPE_INFO,new IdentityKeySelector<>(),new TestFunctionWithOutput(keysToRegister),10,2,1,mergedSnapshot)){
    testHarness1.processElement1(new StreamRecord<>("trigger"));
    testHarness2.processElement1(new StreamRecord<>("trigger"));
    Queue<?> output1=testHarness1.getOutput();
    Queue<?> output2=testHarness2.getOutput();
    assertEquals(expected.size(),output1.size());
    for (    Object o : output1) {
      StreamRecord<String> rec=(StreamRecord<String>)o;
      assertTrue(expected.contains(rec.getValue()));
    }
    assertEquals(expected.size(),output2.size());
    for (    Object o : output2) {
      StreamRecord<String> rec=(StreamRecord<String>)o;
      assertTrue(expected.contains(rec.getValue()));
    }
  }
 }
