@Test public void testOperationIfDueToStaleNonce() throws Exception {
  DigestAuthenticationEntryPoint ep=new DigestAuthenticationEntryPoint();
  ep.setRealmName("hello");
  ep.setKey("key");
  MockHttpServletRequest request=new MockHttpServletRequest();
  request.setRequestURI("/some_path");
  MockHttpServletResponse response=new MockHttpServletResponse();
  ep.afterPropertiesSet();
  ep.commence(request,response,new NonceExpiredException("expired nonce"));
  assertThat(response.getStatus()).isEqualTo(401);
  assertThat(response.getHeader("WWW-Authenticate").toString()).startsWith("Digest ");
  String header=response.getHeader("WWW-Authenticate").toString().substring(7);
  String[] headerEntries=StringUtils.commaDelimitedListToStringArray(header);
  Map<String,String> headerMap=DigestAuthUtils.splitEachArrayElementAndCreateMap(headerEntries,"=","\"");
  assertThat(headerMap.get("realm")).isEqualTo("hello");
  assertThat(headerMap.get("qop")).isEqualTo("auth");
  assertThat(headerMap.get("stale")).isEqualTo("true");
  checkNonceValid(headerMap.get("nonce"));
}
