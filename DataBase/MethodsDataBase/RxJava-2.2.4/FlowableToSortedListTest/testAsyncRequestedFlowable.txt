@Test(timeout=2000) @Ignore("PublishProcessor no longer emits without requests so this test fails due to the race of onComplete and request") public void testAsyncRequestedFlowable(){
  Scheduler.Worker w=Schedulers.newThread().createWorker();
  try {
    for (int i=0; i < 1000; i++) {
      if (i % 50 == 0) {
        System.out.println("testAsyncRequested -> " + i);
      }
      PublishProcessor<Integer> source=PublishProcessor.create();
      Flowable<List<Integer>> sorted=source.toSortedList().toFlowable();
      final CyclicBarrier cb=new CyclicBarrier(2);
      final TestSubscriber<List<Integer>> ts=new TestSubscriber<List<Integer>>(0L);
      sorted.subscribe(ts);
      w.schedule(new Runnable(){
        @Override public void run(){
          await(cb);
          ts.request(1);
        }
      }
);
      source.onNext(1);
      await(cb);
      source.onComplete();
      ts.awaitTerminalEvent(1,TimeUnit.SECONDS);
      ts.assertTerminated();
      ts.assertNoErrors();
      ts.assertValue(Arrays.asList(1));
    }
  }
  finally {
    w.dispose();
  }
}
