@Test public void testUsingDisposesEagerlyBeforeError(){
  final List<String> events=new ArrayList<String>();
  Callable<Resource> resourceFactory=createResourceFactory(events);
  final Consumer<Throwable> onError=createOnErrorAction(events);
  final Action unsub=createUnsubAction(events);
  Function<Resource,Flowable<String>> observableFactory=new Function<Resource,Flowable<String>>(){
    @Override public Flowable<String> apply(    Resource resource){
      return Flowable.fromArray(resource.getTextFromWeb().split(" ")).concatWith(Flowable.<String>error(new RuntimeException()));
    }
  }
;
  Subscriber<String> subscriber=TestHelper.mockSubscriber();
  Flowable<String> flowable=Flowable.using(resourceFactory,observableFactory,new DisposeAction(),true).doOnCancel(unsub).doOnError(onError);
  flowable.safeSubscribe(subscriber);
  assertEquals(Arrays.asList("disposed","error"),events);
}
