@Test public void testToMapWithFactory(){
  Flowable<String> source=Flowable.just("a","bb","ccc","dddd");
  Callable<Map<Integer,String>> mapFactory=new Callable<Map<Integer,String>>(){
    @Override public Map<Integer,String> call(){
      return new LinkedHashMap<Integer,String>(){
        private static final long serialVersionUID=-3296811238780863394L;
        @Override protected boolean removeEldestEntry(        Map.Entry<Integer,String> eldest){
          return size() > 3;
        }
      }
;
    }
  }
;
  Function<String,Integer> lengthFunc=new Function<String,Integer>(){
    @Override public Integer apply(    String t1){
      return t1.length();
    }
  }
;
  Single<Map<Integer,String>> mapped=source.toMap(lengthFunc,new Function<String,String>(){
    @Override public String apply(    String v){
      return v;
    }
  }
,mapFactory);
  Map<Integer,String> expected=new LinkedHashMap<Integer,String>();
  expected.put(2,"bb");
  expected.put(3,"ccc");
  expected.put(4,"dddd");
  mapped.subscribe(singleObserver);
  verify(singleObserver,never()).onError(any(Throwable.class));
  verify(singleObserver,times(1)).onSuccess(expected);
}
