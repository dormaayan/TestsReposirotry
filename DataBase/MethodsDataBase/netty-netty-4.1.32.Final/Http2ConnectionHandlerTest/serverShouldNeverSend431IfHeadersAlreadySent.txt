@Test public void serverShouldNeverSend431IfHeadersAlreadySent() throws Exception {
  int padding=0;
  handler=newHandler();
  Http2Exception e=new Http2Exception.HeaderListSizeException(STREAM_ID,PROTOCOL_ERROR,"Header size exceeded max allowed size 8196",true);
  when(stream.id()).thenReturn(STREAM_ID);
  when(connection.isServer()).thenReturn(true);
  when(stream.isHeadersSent()).thenReturn(true);
  when(remote.lastStreamCreated()).thenReturn(STREAM_ID);
  when(frameWriter.writeRstStream(eq(ctx),eq(STREAM_ID),eq(PROTOCOL_ERROR.code()),eq(promise))).thenReturn(future);
  handler.exceptionCaught(ctx,e);
  verify(encoder,never()).writeHeaders(eq(ctx),eq(STREAM_ID),any(Http2Headers.class),eq(padding),eq(true),eq(promise));
  verify(frameWriter).writeRstStream(ctx,STREAM_ID,PROTOCOL_ERROR.code(),promise);
}
