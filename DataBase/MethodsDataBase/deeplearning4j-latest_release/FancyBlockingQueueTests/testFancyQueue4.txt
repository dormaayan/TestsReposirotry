/** 
 * This test checks for compatibility with single producer - single consumer model
 * @throws Exception
 */
@Test public void testFancyQueue4() throws Exception {
  final FancyBlockingQueue<Integer> queue=new FancyBlockingQueue<>(new LinkedBlockingQueue<Integer>(512),4);
  long f=0;
  for (int x=0; x < 512; x++) {
    queue.add(x);
    f+=x;
  }
  assertEquals(512,queue.size());
  final AtomicLong e=new AtomicLong(0);
  queue.fallbackToSingleConsumerMode(true);
  Thread[] threads=new Thread[1];
  for (int x=0; x < 1; x++) {
    final int t=x;
    threads[x]=new Thread(new Runnable(){
      @Override public void run(){
        while (!queue.isEmpty()) {
          Integer i=queue.poll();
          e.addAndGet(i);
        }
      }
    }
);
    threads[x].start();
  }
  for (int x=0; x < 1; x++) {
    threads[x].join();
  }
  assertEquals(f,e.get());
}
