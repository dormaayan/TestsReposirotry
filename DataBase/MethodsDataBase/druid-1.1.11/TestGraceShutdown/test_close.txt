public void test_close() throws Exception {
  final int threadCount=100;
  Thread[] threads=new Thread[threadCount];
  final CountDownLatch startLatch=new CountDownLatch(1);
  final CountDownLatch endLatch=new CountDownLatch(threadCount);
  for (int i=0; i < threadCount; ++i) {
    threads[i]=new Thread("thread-" + i){
      public void run(){
        try {
          startLatch.await();
          Connection conn=dataSource.getConnection();
        }
 catch (        DataSourceDisableException ex) {
        }
catch (        Exception e) {
          e.printStackTrace();
        }
 finally {
          endLatch.countDown();
        }
      }
    }
;
  }
  startLatch.countDown();
  for (int i=0; i < threadCount; ++i) {
    threads[i].start();
  }
  Thread.sleep(1000);
  new Thread("close thread"){
    public void run(){
      dataSource.close();
    }
  }
.start();
  Assert.assertTrue(endLatch.await(60,TimeUnit.SECONDS));
}
