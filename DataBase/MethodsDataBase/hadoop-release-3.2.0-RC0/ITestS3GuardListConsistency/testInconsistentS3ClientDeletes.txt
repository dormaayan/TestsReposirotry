@Test public void testInconsistentS3ClientDeletes() throws Throwable {
  Assume.assumeTrue(getConfiguration().getInt(LIST_VERSION,DEFAULT_LIST_VERSION) == 2);
  S3AFileSystem fs=getFileSystem();
  Path root=path("testInconsistentClient" + DEFAULT_DELAY_KEY_SUBSTRING);
  for (int i=0; i < 3; i++) {
    fs.mkdirs(new Path(root,"dir" + i));
    touch(fs,new Path(root,"file" + i));
    for (int j=0; j < 3; j++) {
      touch(fs,new Path(new Path(root,"dir" + i),"file" + i + "-"+ j));
    }
  }
  clearInconsistency(fs);
  String key=fs.pathToKey(root) + "/";
  ListObjectsV2Result preDeleteDelimited=listObjectsV2(fs,key,"/");
  ListObjectsV2Result preDeleteUndelimited=listObjectsV2(fs,key,null);
  fs.delete(root,true);
  ListObjectsV2Result postDeleteDelimited=listObjectsV2(fs,key,"/");
  ListObjectsV2Result postDeleteUndelimited=listObjectsV2(fs,key,null);
  assertListSizeEqual("InconsistentAmazonS3Client added back objects incorrectly " + "in a non-recursive listing",preDeleteDelimited.getObjectSummaries(),postDeleteDelimited.getObjectSummaries());
  assertListSizeEqual("InconsistentAmazonS3Client added back prefixes incorrectly " + "in a non-recursive listing",preDeleteDelimited.getCommonPrefixes(),postDeleteDelimited.getCommonPrefixes());
  assertListSizeEqual("InconsistentAmazonS3Client added back objects incorrectly " + "in a recursive listing",preDeleteUndelimited.getObjectSummaries(),postDeleteUndelimited.getObjectSummaries());
  assertListSizeEqual("InconsistentAmazonS3Client added back prefixes incorrectly " + "in a recursive listing",preDeleteUndelimited.getCommonPrefixes(),postDeleteUndelimited.getCommonPrefixes());
}
