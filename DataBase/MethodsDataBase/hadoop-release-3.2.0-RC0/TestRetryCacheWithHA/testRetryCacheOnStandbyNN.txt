/** 
 * 1. Run a set of operations 2. Trigger the NN failover 3. Check the retry cache on the original standby NN
 */
@Test(timeout=60000) public void testRetryCacheOnStandbyNN() throws Exception {
  DFSTestUtil.runOperations(cluster,dfs,conf,BlockSize,0);
  FSNamesystem fsn0=cluster.getNamesystem(0);
  LightWeightCache<CacheEntry,CacheEntry> cacheSet=(LightWeightCache<CacheEntry,CacheEntry>)fsn0.getRetryCache().getCacheSet();
  assertEquals("Retry cache size is wrong",39,cacheSet.size());
  Map<CacheEntry,CacheEntry> oldEntries=new HashMap<CacheEntry,CacheEntry>();
  Iterator<CacheEntry> iter=cacheSet.iterator();
  while (iter.hasNext()) {
    CacheEntry entry=iter.next();
    oldEntries.put(entry,entry);
  }
  cluster.getNameNode(0).getRpcServer().rollEditLog();
  cluster.getNameNode(1).getNamesystem().getEditLogTailer().doTailEdits();
  cluster.shutdownNameNode(0);
  cluster.transitionToActive(1);
  FSNamesystem fsn1=cluster.getNamesystem(1);
  cacheSet=(LightWeightCache<CacheEntry,CacheEntry>)fsn1.getRetryCache().getCacheSet();
  assertEquals("Retry cache size is wrong",38,cacheSet.size());
  iter=cacheSet.iterator();
  while (iter.hasNext()) {
    CacheEntry entry=iter.next();
    assertTrue(oldEntries.containsKey(entry));
  }
}
