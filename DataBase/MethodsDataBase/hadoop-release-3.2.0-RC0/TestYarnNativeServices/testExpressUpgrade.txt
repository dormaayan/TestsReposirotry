@Test(timeout=200000) public void testExpressUpgrade() throws Exception {
  setupInternal(NUM_NMS);
  getConf().setBoolean(YARN_SERVICE_UPGRADE_ENABLED,true);
  ServiceClient client=createClient(getConf());
  Service service=createExampleApplication();
  client.actionCreate(service);
  waitForServiceToBeStable(client,service);
  Component component=service.getComponents().iterator().next();
  service.setState(ServiceState.EXPRESS_UPGRADING);
  service.setVersion("v2");
  component.getConfiguration().getEnv().put("key1","val1");
  Component component2=service.getComponent("compb");
  component2.getConfiguration().getEnv().put("key2","val2");
  client.actionUpgradeExpress(service);
  waitForServiceToBeStable(client,service);
  Service active=client.getStatus(service.getName());
  Assert.assertEquals("version mismatch",service.getVersion(),active.getVersion());
  Assert.assertEquals("component not stable",ComponentState.STABLE,active.getComponent(component.getName()).getState());
  Assert.assertEquals("compa does not have new env","val1",active.getComponent(component.getName()).getConfiguration().getEnv("key1"));
  Assert.assertEquals("compb does not have new env","val2",active.getComponent(component2.getName()).getConfiguration().getEnv("key2"));
  LOG.info("Stop/destroy service {}",service);
  client.actionStop(service.getName(),true);
  client.actionDestroy(service.getName());
}
