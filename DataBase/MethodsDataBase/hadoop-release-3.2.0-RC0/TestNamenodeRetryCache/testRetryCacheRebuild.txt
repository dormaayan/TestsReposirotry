/** 
 * After run a set of operations, restart NN and check if the retry cache has been rebuilt based on the editlog.
 */
@Test public void testRetryCacheRebuild() throws Exception {
  DFSTestUtil.runOperations(cluster,filesystem,conf,BlockSize,0);
  FSNamesystem namesystem=cluster.getNamesystem();
  LightWeightCache<CacheEntry,CacheEntry> cacheSet=(LightWeightCache<CacheEntry,CacheEntry>)namesystem.getRetryCache().getCacheSet();
  assertEquals("Retry cache size is wrong",39,cacheSet.size());
  Map<CacheEntry,CacheEntry> oldEntries=new HashMap<CacheEntry,CacheEntry>();
  Iterator<CacheEntry> iter=cacheSet.iterator();
  while (iter.hasNext()) {
    CacheEntry entry=iter.next();
    oldEntries.put(entry,entry);
  }
  cluster.restartNameNode();
  cluster.waitActive();
  namesystem=cluster.getNamesystem();
  assertTrue(namesystem.hasRetryCache());
  cacheSet=(LightWeightCache<CacheEntry,CacheEntry>)namesystem.getRetryCache().getCacheSet();
  assertEquals("Retry cache size is wrong",38,cacheSet.size());
  iter=cacheSet.iterator();
  while (iter.hasNext()) {
    CacheEntry entry=iter.next();
    assertTrue(oldEntries.containsKey(entry));
  }
}
