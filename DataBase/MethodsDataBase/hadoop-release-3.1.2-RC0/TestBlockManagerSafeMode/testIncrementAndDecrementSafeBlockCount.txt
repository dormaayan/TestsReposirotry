/** 
 * Test when the block safe increment and decrement interleave. Both the increment and decrement will be a no-op if the safe mode is OFF. The safe mode status lifecycle: OFF -> PENDING_THRESHOLD -> OFF
 */
@Test(timeout=30000) public void testIncrementAndDecrementSafeBlockCount(){
  bmSafeMode.activate(BLOCK_TOTAL);
  Whitebox.setInternalState(bmSafeMode,"extension",0);
  mockBlockManagerForBlockSafeDecrement();
  for (long i=1; i <= BLOCK_TOTAL; i++) {
    BlockInfo blockInfo=mock(BlockInfo.class);
    doReturn(false).when(blockInfo).isStriped();
    bmSafeMode.incrementSafeBlockCount(1,blockInfo);
    bmSafeMode.decrementSafeBlockCount(blockInfo);
    bmSafeMode.incrementSafeBlockCount(1,blockInfo);
    if (i < BLOCK_THRESHOLD) {
      assertEquals(i,getblockSafe());
      assertTrue(bmSafeMode.isInSafeMode());
    }
 else {
      assertEquals(BLOCK_THRESHOLD,getblockSafe());
      assertFalse(bmSafeMode.isInSafeMode());
    }
  }
}
