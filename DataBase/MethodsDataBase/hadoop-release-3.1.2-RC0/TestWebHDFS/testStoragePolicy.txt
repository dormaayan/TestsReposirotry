@Test public void testStoragePolicy() throws Exception {
  MiniDFSCluster cluster=null;
  final Configuration conf=WebHdfsTestUtil.createConf();
  final Path path=new Path("/file");
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).build();
    final DistributedFileSystem dfs=cluster.getFileSystem();
    final WebHdfsFileSystem webHdfs=WebHdfsTestUtil.getWebHdfsFileSystem(conf,WebHdfsConstants.WEBHDFS_SCHEME);
    BlockStoragePolicy[] dfsPolicies=(BlockStoragePolicy[])dfs.getAllStoragePolicies().toArray();
    BlockStoragePolicy[] webHdfsPolicies=(BlockStoragePolicy[])webHdfs.getAllStoragePolicies().toArray();
    Assert.assertTrue(Arrays.equals(dfsPolicies,webHdfsPolicies));
    DFSTestUtil.createFile(dfs,path,0,(short)1,0L);
    BlockStoragePolicySpi defaultdfsPolicy=dfs.getStoragePolicy(path);
    webHdfs.setStoragePolicy(path,HdfsConstants.COLD_STORAGE_POLICY_NAME);
    BlockStoragePolicySpi dfsPolicy=dfs.getStoragePolicy(path);
    BlockStoragePolicySpi webHdfsPolicy=webHdfs.getStoragePolicy(path);
    Assert.assertEquals(HdfsConstants.COLD_STORAGE_POLICY_NAME.toString(),webHdfsPolicy.getName());
    Assert.assertEquals(webHdfsPolicy,dfsPolicy);
    webHdfs.unsetStoragePolicy(path);
    Assert.assertEquals(defaultdfsPolicy,webHdfs.getStoragePolicy(path));
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
