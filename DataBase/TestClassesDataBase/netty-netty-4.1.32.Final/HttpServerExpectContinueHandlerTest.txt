public class HttpServerExpectContinueHandlerTest {
  @Test public void shouldRespondToExpectedHeader(){
    EmbeddedChannel channel=new EmbeddedChannel(new HttpServerExpectContinueHandler(){
      @Override protected HttpResponse acceptMessage(      HttpRequest request){
        HttpResponse response=new DefaultFullHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.CONTINUE);
        response.headers().set("foo","bar");
        return response;
      }
    }
);
    HttpRequest request=new DefaultFullHttpRequest(HttpVersion.HTTP_1_1,HttpMethod.GET,"/");
    HttpUtil.set100ContinueExpected(request,true);
    channel.writeInbound(request);
    HttpResponse response=channel.readOutbound();
    assertThat(response.status(),is(HttpResponseStatus.CONTINUE));
    assertThat(response.headers().get("foo"),is("bar"));
    ReferenceCountUtil.release(response);
    HttpRequest processedRequest=channel.readInbound();
    assertFalse(processedRequest.headers().contains(HttpHeaderNames.EXPECT));
    ReferenceCountUtil.release(processedRequest);
    assertFalse(channel.finishAndReleaseAll());
  }
  @Test public void shouldAllowCustomResponses(){
    EmbeddedChannel channel=new EmbeddedChannel(new HttpServerExpectContinueHandler(){
      @Override protected HttpResponse acceptMessage(      HttpRequest request){
        return null;
      }
      @Override protected HttpResponse rejectResponse(      HttpRequest request){
        return new DefaultFullHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.REQUEST_ENTITY_TOO_LARGE);
      }
    }
);
    HttpRequest request=new DefaultFullHttpRequest(HttpVersion.HTTP_1_1,HttpMethod.GET,"/");
    HttpUtil.set100ContinueExpected(request,true);
    channel.writeInbound(request);
    HttpResponse response=channel.readOutbound();
    assertThat(response.status(),is(HttpResponseStatus.REQUEST_ENTITY_TOO_LARGE));
    ReferenceCountUtil.release(response);
    assertTrue(channel.inboundMessages().isEmpty());
    assertFalse(channel.finishAndReleaseAll());
  }
}
