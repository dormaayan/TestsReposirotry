public class MergeStatFilterTest_tddl_4 extends TestCase {
  private DruidDataSource dataSource;
  protected void setUp() throws Exception {
    TabularData sqlList=JdbcStatManager.getInstance().getSqlList();
    if (sqlList.size() > 0) {
      for (      Object item : JdbcStatManager.getInstance().getSqlList().values()) {
        String text=JSONUtils.toJSONString(item);
        System.out.println(text);
      }
    }
    Assert.assertEquals(0,JdbcStatManager.getInstance().getSqlList().size());
    dataSource=new DruidDataSource();
    dataSource.setUrl("jdbc:mock:xx");
    dataSource.setFilters("mergeStat");
    dataSource.setDbType("mysql");
    dataSource.setConnectionProperties("druid.useGloalDataSourceStat");
    dataSource.setPoolPreparedStatements(true);
  }
  protected void tearDown() throws Exception {
    JdbcUtils.close(dataSource);
    Assert.assertEquals(0,JdbcStatManager.getInstance().getSqlList().size());
  }
  public void test_merge() throws Exception {
    for (int i=1000; i < 2000; ++i) {
      String tableName="t_" + i;
      Connection conn=dataSource.getConnection();
      String sql="update " + tableName + " SET a = ? WHERE b = ?";
      PreparedStatement stmt=conn.prepareStatement(sql);
      stmt.setString(1,"aaa");
      stmt.setInt(1,2);
      stmt.execute();
      stmt.close();
      conn.close();
    }
    Assert.assertEquals(1,dataSource.getDataSourceStat().getSqlStatMap().size());
  }
}
