/** 
 * @author Madhura Bhave
 * @author Stephane Nicoll
 */
@RunWith(SpringRunner.class) @SpringBootTest(webEnvironment=SpringBootTest.WebEnvironment.RANDOM_PORT) public class SampleActuatorCustomSecurityApplicationTests {
  @Autowired private Environment environment;
  @Test public void homeIsSecure(){
    @SuppressWarnings("rawtypes") ResponseEntity<Map> entity=restTemplate().getForEntity("/",Map.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
    @SuppressWarnings("unchecked") Map<String,Object> body=entity.getBody();
    assertThat(body.get("error")).isEqualTo("Unauthorized");
    assertThat(entity.getHeaders()).doesNotContainKey("Set-Cookie");
  }
  @Test public void testInsecureApplicationPath(){
    @SuppressWarnings("rawtypes") ResponseEntity<Map> entity=restTemplate().getForEntity("/foo",Map.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.INTERNAL_SERVER_ERROR);
    @SuppressWarnings("unchecked") Map<String,Object> body=entity.getBody();
    assertThat((String)body.get("message")).contains("Expected exception in controller");
  }
  @Test public void testInsecureStaticResources(){
    ResponseEntity<String> entity=restTemplate().getForEntity("/css/bootstrap.min.css",String.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(entity.getBody()).contains("body");
  }
  @Test public void actuatorInsecureEndpoint(){
    ResponseEntity<String> entity=restTemplate().getForEntity("/actuator/health",String.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(entity.getBody()).contains("\"status\":\"UP\"");
  }
  @Test public void actuatorLinksIsSecure(){
    ResponseEntity<Object> entity=restTemplate().getForEntity("/actuator",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
    entity=adminRestTemplate().getForEntity("/actuator",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
  }
  @Test public void actuatorSecureEndpointWithAnonymous(){
    ResponseEntity<Object> entity=restTemplate().getForEntity("/actuator/env",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
  }
  @Test public void actuatorSecureEndpointWithUnauthorizedUser(){
    ResponseEntity<Object> entity=userRestTemplate().getForEntity("/actuator/env",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
  }
  @Test public void actuatorSecureEndpointWithAuthorizedUser(){
    ResponseEntity<Object> entity=adminRestTemplate().getForEntity("/actuator/env",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
  }
  @Test public void actuatorCustomMvcSecureEndpointWithAnonymous(){
    ResponseEntity<String> entity=restTemplate().getForEntity("/actuator/example/echo?text={t}",String.class,"test");
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
  }
  @Test public void actuatorCustomMvcSecureEndpointWithUnauthorizedUser(){
    ResponseEntity<String> entity=userRestTemplate().getForEntity("/actuator/example/echo?text={t}",String.class,"test");
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
  }
  @Test public void actuatorCustomMvcSecureEndpointWithAuthorizedUser(){
    ResponseEntity<String> entity=adminRestTemplate().getForEntity("/actuator/example/echo?text={t}",String.class,"test");
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(entity.getBody()).isEqualTo("test");
    assertThat(entity.getHeaders().getFirst("echo")).isEqualTo("test");
  }
  @Test public void actuatorExcludedFromEndpointRequestMatcher(){
    ResponseEntity<Object> entity=userRestTemplate().getForEntity("/actuator/mappings",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
  }
  @Test public void mvcMatchersCanBeUsedToSecureActuators(){
    ResponseEntity<Object> entity=beansRestTemplate().getForEntity("/actuator/beans",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
    entity=beansRestTemplate().getForEntity("/actuator/beans/",Object.class);
    assertThat(entity.getStatusCode()).isEqualTo(HttpStatus.OK);
  }
  private TestRestTemplate restTemplate(){
    return configure(new TestRestTemplate());
  }
  private TestRestTemplate adminRestTemplate(){
    return configure(new TestRestTemplate("admin","admin"));
  }
  private TestRestTemplate userRestTemplate(){
    return configure(new TestRestTemplate("user","password"));
  }
  private TestRestTemplate beansRestTemplate(){
    return configure(new TestRestTemplate("beans","beans"));
  }
  private TestRestTemplate configure(  TestRestTemplate restTemplate){
    restTemplate.setUriTemplateHandler(new LocalHostUriTemplateHandler(this.environment));
    return restTemplate;
  }
}
