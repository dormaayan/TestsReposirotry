/** 
 * Tests a  {@link StackedRequestHandler} with multiple {@link RequestHandler2} added. Beforehooks should be executed in normal order (i.e. first, second, then third in respect to what order they were added to the  {@link StackedRequestHandler}) and after hooks should be executed in reverse order (i.e. third, second, first)
 */
public static class MultipleRequestHandlers {
  private StackedRequestHandler stackedRequestHandler;
  @Mock private RequestHandler2 first;
  @Mock private RequestHandler2 second;
  @Mock private RequestHandler2 third;
  @Mock private Request<?> request;
  private Response<?> response;
  @Before public void setup(){
    MockitoAnnotations.initMocks(this);
    stackedRequestHandler=new StackedRequestHandler(first,second,third);
    response=new Response<String>("Dummy response",new HttpResponse(request,new HttpGet()));
  }
  @Test public void beforeMarshalling_CalledInOrder(){
    stackedRequestHandler.beforeMarshalling(null);
    InOrder inOrder=inOrder(first,second,third);
    inOrder.verify(first).beforeMarshalling(null);
    inOrder.verify(second).beforeMarshalling(null);
    inOrder.verify(third).beforeMarshalling(null);
  }
  /** 
 * The beforeMarshalling step is a bit different. It's expected to take the potentially modified  {@link AmazonWebServiceRequest} returned by{@link RequestHandler2#beforeMarshalling(AmazonWebServiceRequest)} and forward thatresult as input to the next request handler in the chain. This tests makes sure that each request handler forwards the appropriate the result to the next in the chain and that the end result is what's returned by the last request handler in the chain
 */
  @Test public void beforeMarshalling_ModifiedRequestForwardedToNextInChain(){
    final AmazonWebServiceRequest origAwsRequest=mock(AmazonWebServiceRequest.class);
    final AmazonWebServiceRequest afterFirstAwsRequest=mock(AmazonWebServiceRequest.class);
    final AmazonWebServiceRequest afterSecondAwsRequest=mock(AmazonWebServiceRequest.class);
    final AmazonWebServiceRequest afterThirdAwsRequest=mock(AmazonWebServiceRequest.class);
    doReturn(afterFirstAwsRequest).when(first).beforeMarshalling(origAwsRequest);
    doReturn(afterSecondAwsRequest).when(second).beforeMarshalling(afterFirstAwsRequest);
    doReturn(afterThirdAwsRequest).when(third).beforeMarshalling(afterSecondAwsRequest);
    assertEquals(afterThirdAwsRequest,stackedRequestHandler.beforeMarshalling(origAwsRequest));
    InOrder inOrder=inOrder(first,second,third);
    inOrder.verify(first).beforeMarshalling(origAwsRequest);
    inOrder.verify(second).beforeMarshalling(afterFirstAwsRequest);
    inOrder.verify(third).beforeMarshalling(afterSecondAwsRequest);
  }
  @Test public void beforeRequest_CalledInOrder(){
    stackedRequestHandler.beforeRequest(request);
    InOrder inOrder=inOrder(first,second,third);
    inOrder.verify(first).beforeRequest(request);
    inOrder.verify(second).beforeRequest(request);
    inOrder.verify(third).beforeRequest(request);
  }
  @Test public void beforeUnmarshalling_CalledInOrder(){
    stackedRequestHandler.beforeUnmarshalling(request,null);
    InOrder inOrder=inOrder(third,second,first);
    inOrder.verify(third).beforeUnmarshalling(request,null);
    inOrder.verify(second).beforeUnmarshalling(request,null);
    inOrder.verify(first).beforeUnmarshalling(request,null);
  }
  @Test public void beforeUnmarshalling_ModifiedResponseForwardedToNextInChain(){
    final HttpResponse origHttpResponse=mock(HttpResponse.class);
    final HttpResponse afterFirstHttpResponse=mock(HttpResponse.class);
    final HttpResponse afterSecondHttpResponse=mock(HttpResponse.class);
    final HttpResponse afterThirdHttpResponse=mock(HttpResponse.class);
    doReturn(afterThirdHttpResponse).when(third).beforeUnmarshalling(request,origHttpResponse);
    doReturn(afterSecondHttpResponse).when(second).beforeUnmarshalling(request,afterThirdHttpResponse);
    doReturn(afterFirstHttpResponse).when(first).beforeUnmarshalling(request,afterSecondHttpResponse);
    assertEquals(afterFirstHttpResponse,stackedRequestHandler.beforeUnmarshalling(request,origHttpResponse));
    InOrder inOrder=inOrder(third,second,first);
    inOrder.verify(third).beforeUnmarshalling(request,origHttpResponse);
    inOrder.verify(second).beforeUnmarshalling(request,afterThirdHttpResponse);
    inOrder.verify(first).beforeUnmarshalling(request,afterSecondHttpResponse);
  }
  @Test public void afterResponse_CalledInOrder(){
    stackedRequestHandler.afterResponse(request,response);
    InOrder inOrder=inOrder(third,second,first);
    inOrder.verify(third).afterResponse(request,response);
    inOrder.verify(second).afterResponse(request,response);
    inOrder.verify(first).afterResponse(request,response);
  }
  @Test public void afterError_CalledInOrder(){
    final Exception exception=new AmazonServiceException("Some service failure");
    stackedRequestHandler.afterError(request,response,exception);
    InOrder inOrder=inOrder(third,second,first);
    inOrder.verify(third).afterError(request,response,exception);
    inOrder.verify(second).afterError(request,response,exception);
    inOrder.verify(first).afterError(request,response,exception);
  }
}
