/** 
 * @author ogondza.
 */
public class PingThreadTest {
  @Rule public JenkinsRule j=new JenkinsRule();
  @Test public void failedPingThreadResetsComputerChannel() throws Exception {
    assumeFalse("We simulate hung agent by sending the SIGTSTP signal",Functions.isWindows());
    DumbSlave slave=j.createOnlineSlave();
    Computer computer=slave.toComputer();
    Channel channel=(Channel)slave.getChannel();
    String pid=channel.call(new GetPid());
    PingThread pingThread=null;
    for (    Thread it : Thread.getAllStackTraces().keySet()) {
      if (it instanceof PingThread && it.getName().endsWith(channel.toString())) {
        pingThread=(PingThread)it;
      }
    }
    assertNotNull(pingThread);
    assert new ProcessBuilder("kill","-TSTP",pid).start().waitFor() == 0;
    try {
      Method onDead=PingThread.class.getDeclaredMethod("onDead",Throwable.class);
      onDead.setAccessible(true);
      onDead.invoke(pingThread,new TimeoutException("No ping"));
      try {
        channel.call(new GetPid());
        fail();
      }
 catch (      ChannelClosedException ex) {
      }
      assertNull(slave.getComputer().getChannel());
      assertNull(computer.getChannel());
    }
  finally {
      assert new ProcessBuilder("kill","-CONT",pid).start().waitFor() == 0;
    }
  }
private static final class GetPid extends MasterToSlaveCallable<String,IOException> {
    @Override public String call() throws IOException {
      return ManagementFactory.getRuntimeMXBean().getName().replaceAll("@.*","");
    }
  }
}
