/** 
 * Freestyle publishers statuses tests
 * @author Kanstantsin Shautsou
 */
public class FreestyleJobPublisherTest {
  @Rule public JenkinsRule j=new JenkinsRule();
  /** 
 * Execute all publishers even one of publishers return false.
 */
  @Issue("JENKINS-26964") @Test public void testFreestyleWithFalsePublisher() throws Exception {
    FreeStyleProject p=j.createFreeStyleProject();
    p.getPublishersList().add(new TrueFalsePublisher(true));
    p.getPublishersList().add(new TrueFalsePublisher(false));
    p.getPublishersList().add(new ResultWriterPublisher("result.txt"));
    final ArtifactArchiver artifactArchiver=new ArtifactArchiver("result.txt");
    artifactArchiver.setOnlyIfSuccessful(false);
    p.getPublishersList().add(artifactArchiver);
    FreeStyleBuild b=p.scheduleBuild2(0).get();
    assertEquals("Build must fail, because we used FalsePublisher",b.getResult(),Result.FAILURE);
    File file=new File(b.getArtifactsDir(),"result.txt");
    assertTrue("ArtifactArchiver is executed even prior publisher fails",file.exists());
    assertTrue("Publisher, after publisher with return false status, must see FAILURE status",FileUtils.readFileToString(file).equals(Result.FAILURE.toString()));
  }
  /** 
 * Execute all publishers even one of them throws AbortException.
 */
  @Issue("JENKINS-26964") @Test public void testFreestyleWithExceptionPublisher() throws Exception {
    FreeStyleProject p=j.createFreeStyleProject();
    p.getPublishersList().add(new TrueFalsePublisher(true));
    p.getPublishersList().add(new AbortExceptionPublisher());
    p.getPublishersList().add(new ResultWriterPublisher("result.txt"));
    final ArtifactArchiver artifactArchiver=new ArtifactArchiver("result.txt");
    artifactArchiver.setOnlyIfSuccessful(false);
    p.getPublishersList().add(artifactArchiver);
    FreeStyleBuild b=p.scheduleBuild2(0).get();
    assertEquals("Build must fail, because we used AbortExceptionPublisher",b.getResult(),Result.FAILURE);
    j.assertLogNotContains("\tat",b);
    j.assertLogContains("Threw AbortException from publisher!",b);
    File file=new File(b.getArtifactsDir(),"result.txt");
    assertTrue("ArtifactArchiver is executed even prior publisher fails",file.exists());
    assertTrue("Third publisher must see FAILURE status",FileUtils.readFileToString(file).equals(Result.FAILURE.toString()));
  }
  /** 
 * Execute all publishers even one of them throws any Exceptions.
 */
  @Issue("JENKINS-26964") @Test public void testFreestyleWithIOExceptionPublisher() throws Exception {
    FreeStyleProject p=j.createFreeStyleProject();
    p.getPublishersList().add(new TrueFalsePublisher(true));
    p.getPublishersList().add(new IOExceptionPublisher());
    p.getPublishersList().add(new ResultWriterPublisher("result.txt"));
    final ArtifactArchiver artifactArchiver=new ArtifactArchiver("result.txt");
    artifactArchiver.setOnlyIfSuccessful(false);
    p.getPublishersList().add(artifactArchiver);
    FreeStyleBuild b=p.scheduleBuild2(0).get();
    assertEquals("Build must fail, because we used FalsePublisher",b.getResult(),Result.FAILURE);
    j.assertLogContains("\tat hudson.model.utils.IOExceptionPublisher",b);
    j.assertLogContains("Threw IOException from publisher!",b);
    File file=new File(b.getArtifactsDir(),"result.txt");
    assertTrue("ArtifactArchiver is executed even prior publisher fails",file.exists());
    assertTrue("Third publisher must see FAILURE status",FileUtils.readFileToString(file).equals(Result.FAILURE.toString()));
  }
}
