/** 
 * Tests  {@link FileContext.#deleteOnExit(Path)} functionality.
 */
public class TestFileContextDeleteOnExit {
  private static int blockSize=1024;
  private static int numBlocks=2;
  private final FileContextTestHelper helper=new FileContextTestHelper();
  private FileContext fc;
  @Before public void setup() throws IOException {
    fc=FileContext.getLocalFSFileContext();
  }
  @After public void tearDown() throws IOException {
    fc.delete(helper.getTestRootPath(fc),true);
  }
  private void checkDeleteOnExitData(  int size,  FileContext fc,  Path... paths){
    Assert.assertEquals(size,FileContext.DELETE_ON_EXIT.size());
    Set<Path> set=FileContext.DELETE_ON_EXIT.get(fc);
    Assert.assertEquals(paths.length,(set == null ? 0 : set.size()));
    for (    Path path : paths) {
      Assert.assertTrue(set.contains(path));
    }
  }
  @Test public void testDeleteOnExit() throws Exception {
    Path file1=helper.getTestRootPath(fc,"file1");
    createFile(fc,file1,numBlocks,blockSize);
    fc.deleteOnExit(file1);
    checkDeleteOnExitData(1,fc,file1);
    Assert.assertTrue(ShutdownHookManager.get().hasShutdownHook(FileContext.FINALIZER));
    Path file2=helper.getTestRootPath(fc,"dir1/file2");
    createFile(fc,file2,numBlocks,blockSize);
    fc.deleteOnExit(file2);
    checkDeleteOnExitData(1,fc,file1,file2);
    Path dir=helper.getTestRootPath(fc,"dir3/dir4/dir5/dir6");
    createFile(fc,dir,numBlocks,blockSize);
    fc.deleteOnExit(dir);
    checkDeleteOnExitData(1,fc,file1,file2,dir);
    FileContext.FINALIZER.run();
    checkDeleteOnExitData(0,fc,new Path[0]);
    Assert.assertFalse(exists(fc,file1));
    Assert.assertFalse(exists(fc,file2));
    Assert.assertFalse(exists(fc,dir));
  }
}
