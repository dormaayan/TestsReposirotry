public class ConstraintIndexFailureIT {
  @Rule public final RandomRule random=new RandomRule();
  @Rule public final TestDirectory directory=TestDirectory.testDirectory();
  @Test public void shouldFailToValidateConstraintsIfUnderlyingIndexIsFailed() throws Exception {
    File dir=directory.databaseDir();
    GraphDatabaseService db=new TestGraphDatabaseFactory().newEmbeddedDatabase(dir);
    try (Transaction tx=db.beginTx()){
      db.schema().constraintFor(label("Label1")).assertPropertyIsUnique("key1").create();
      tx.success();
    }
  finally {
      db.shutdown();
    }
    FileUtils.deleteRecursively(IndexDirectoryStructure.baseSchemaIndexFolder(dir));
    db=new TestGraphDatabaseFactory().removeKernelExtensions(INDEX_PROVIDERS_FILTER).addKernelExtension(new FailingGenericNativeIndexProviderFactory(INITIAL_STATE)).newEmbeddedDatabase(dir);
    try (Transaction tx=db.beginTx()){
      db.createNode(label("Label1")).setProperty("key1","value1");
      fail("expected exception");
    }
 catch (    ConstraintViolationException e) {
      assertThat(e.getCause(),instanceOf(UnableToValidateConstraintException.class));
      assertThat(e.getCause().getCause().getMessage(),allOf(containsString("The index is in a failed state:"),containsString(INITIAL_STATE_FAILURE_MESSAGE)));
    }
 finally {
      db.shutdown();
    }
  }
}
