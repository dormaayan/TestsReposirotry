public class NeoStoreOpenFailureTest {
  @Rule public PageCacheAndDependenciesRule rules=new PageCacheAndDependenciesRule().with(new DefaultFileSystemRule());
  @Test public void mustCloseAllStoresIfNeoStoresFailToOpen(){
    PageCache pageCache=rules.pageCache();
    DatabaseLayout databaseLayout=rules.directory().databaseLayout();
    Config config=Config.defaults();
    FileSystemAbstraction fs=rules.fileSystem();
    IdGeneratorFactory idGenFactory=new DefaultIdGeneratorFactory(fs);
    LogProvider logProvider=NullLogProvider.getInstance();
    VersionContextSupplier versions=EmptyVersionContextSupplier.EMPTY;
    RecordFormats formats=Standard.LATEST_RECORD_FORMATS;
    new RecordFormatPropertyConfigurator(formats,config).configure();
    boolean create=true;
    StoreType[] storeTypes=StoreType.values();
    OpenOption[] openOptions=new OpenOption[0];
    NeoStores neoStores=new NeoStores(databaseLayout,config,idGenFactory,pageCache,logProvider,fs,versions,formats,create,storeTypes,openOptions);
    File schemaStore=neoStores.getSchemaStore().getStorageFile();
    neoStores.close();
    assumeTrue(schemaStore.setReadable(false));
    assumeTrue(schemaStore.setWritable(false));
    try {
      new NeoStores(databaseLayout,config,idGenFactory,pageCache,logProvider,fs,versions,formats,create,storeTypes,openOptions);
      fail("Opening NeoStores should have thrown.");
    }
 catch (    RuntimeException ignore) {
    }
    pageCache.close();
  }
}
