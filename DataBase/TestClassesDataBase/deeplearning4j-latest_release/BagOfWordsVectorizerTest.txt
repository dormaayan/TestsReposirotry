/** 
 * @author Adam Gibson
 */
@Slf4j public class BagOfWordsVectorizerTest {
  @Rule public TemporaryFolder testDir=new TemporaryFolder();
  @Test(timeout=60000L) public void testBagOfWordsVectorizer() throws Exception {
    File rootDir=new ClassPathResource("rootdir").getFile();
    LabelAwareSentenceIterator iter=new LabelAwareFileSentenceIterator(rootDir);
    List<String> labels=Arrays.asList("label1","label2");
    TokenizerFactory tokenizerFactory=new DefaultTokenizerFactory();
    BagOfWordsVectorizer vectorizer=new BagOfWordsVectorizer.Builder().setMinWordFrequency(1).setStopWords(new ArrayList<String>()).setTokenizerFactory(tokenizerFactory).setIterator(iter).allowParallelTokenization(false).build();
    vectorizer.fit();
    VocabWord word=vectorizer.getVocabCache().wordFor("file.");
    assumeNotNull(word);
    assertEquals(word,vectorizer.getVocabCache().tokenFor("file."));
    assertEquals(2,vectorizer.getVocabCache().totalNumberOfDocs());
    assertEquals(2,word.getSequencesCount());
    assertEquals(2,word.getElementFrequency(),0.1);
    VocabWord word1=vectorizer.getVocabCache().wordFor("1");
    assertEquals(1,word1.getSequencesCount());
    assertEquals(1,word1.getElementFrequency(),0.1);
    log.info("Labels used: " + vectorizer.getLabelsSource().getLabels());
    assertEquals(2,vectorizer.getLabelsSource().getNumberOfLabelsUsed());
    INDArray array=vectorizer.transform("This is 2 file.");
    log.info("Transformed array: " + array);
    assertEquals(5,array.columns());
    VocabCache<VocabWord> vocabCache=vectorizer.getVocabCache();
    assertEquals(2,array.getDouble(vocabCache.tokenFor("This").getIndex()),0.1);
    assertEquals(2,array.getDouble(vocabCache.tokenFor("is").getIndex()),0.1);
    assertEquals(2,array.getDouble(vocabCache.tokenFor("file.").getIndex()),0.1);
    assertEquals(0,array.getDouble(vocabCache.tokenFor("1").getIndex()),0.1);
    assertEquals(1,array.getDouble(vocabCache.tokenFor("2").getIndex()),0.1);
    DataSet dataSet=vectorizer.vectorize("This is 2 file.","label2");
    assertEquals(array,dataSet.getFeatures());
    INDArray labelz=dataSet.getLabels();
    log.info("Labels array: " + labelz);
    int idx2=((IndexAccumulation)Nd4j.getExecutioner().exec(new IMax(labelz))).getFinalResult();
    dataSet=vectorizer.vectorize("This is 1 file.","label1");
    assertEquals(2,dataSet.getFeatures().getDouble(vocabCache.tokenFor("This").getIndex()),0.1);
    assertEquals(2,dataSet.getFeatures().getDouble(vocabCache.tokenFor("is").getIndex()),0.1);
    assertEquals(2,dataSet.getFeatures().getDouble(vocabCache.tokenFor("file.").getIndex()),0.1);
    assertEquals(1,dataSet.getFeatures().getDouble(vocabCache.tokenFor("1").getIndex()),0.1);
    assertEquals(0,dataSet.getFeatures().getDouble(vocabCache.tokenFor("2").getIndex()),0.1);
    int idx1=((IndexAccumulation)Nd4j.getExecutioner().exec(new IMax(dataSet.getLabels()))).getFinalResult();
    assertNotEquals(idx2,idx1);
    File tempFile=createTempFile("fdsf","fdfsdf");
    tempFile.deleteOnExit();
    SerializationUtils.saveObject(vectorizer,tempFile);
    BagOfWordsVectorizer vectorizer2=SerializationUtils.readObject(tempFile);
    vectorizer2.setTokenizerFactory(tokenizerFactory);
    dataSet=vectorizer2.vectorize("This is 2 file.","label2");
    assertEquals(array,dataSet.getFeatures());
  }
  private File createTempFile(  String prefix,  String suffix) throws IOException {
    return testDir.newFile(prefix + "-" + System.nanoTime()+ suffix);
  }
}
