/** 
 * @version 
 */
public class ManagedWireTapTest extends ManagementTestSupport {
  @Override protected CamelContext createCamelContext() throws Exception {
    CamelContext context=super.createCamelContext();
    context.getManagementStrategy().getManagementAgent().setStatisticsLevel(ManagementStatisticsLevel.Extended);
    return context;
  }
  @Test public void testManageWireTap() throws Exception {
    if (isPlatform("aix")) {
      return;
    }
    MockEndpoint foo=getMockEndpoint("mock:foo");
    foo.expectedMessageCount(2);
    MockEndpoint bar=getMockEndpoint("mock:bar");
    bar.expectedMessageCount(1);
    template.sendBodyAndHeader("direct:start","Hello World","whereto","foo");
    template.sendBodyAndHeader("direct:start","Bye World","whereto","foo");
    template.sendBodyAndHeader("direct:start","Hi World","whereto","bar");
    assertMockEndpointsSatisfied();
    MBeanServer mbeanServer=getMBeanServer();
    ObjectName on=ObjectName.getInstance("org.apache.camel:context=camel-1,type=processors,name=\"mysend\"");
    String routeId=(String)mbeanServer.getAttribute(on,"RouteId");
    assertEquals("route1",routeId);
    String camelId=(String)mbeanServer.getAttribute(on,"CamelId");
    assertEquals("camel-1",camelId);
    String state=(String)mbeanServer.getAttribute(on,"State");
    assertEquals(ServiceStatus.Started.name(),state);
    String uri=(String)mbeanServer.getAttribute(on,"Uri");
    assertEquals("direct:${header.whereto}",uri);
    Boolean dynamicUri=(Boolean)mbeanServer.getAttribute(on,"DynamicUri");
    assertTrue(dynamicUri);
    TabularData data=(TabularData)mbeanServer.invoke(on,"extendedInformation",null,null);
    assertNotNull(data);
    assertEquals(2,data.size());
    data=(TabularData)mbeanServer.invoke(on,"explain",new Object[]{false},new String[]{"boolean"});
    assertNotNull(data);
    assertEquals(3,data.size());
    data=(TabularData)mbeanServer.invoke(on,"explain",new Object[]{true},new String[]{"boolean"});
    assertNotNull(data);
    assertEquals(13,data.size());
    String json=(String)mbeanServer.invoke(on,"informationJson",null,null);
    assertNotNull(json);
    assertTrue(json.contains("\"description\": \"Routes a copy of a message (or creates a new message) to a secondary destination while continue routing the original message"));
    assertTrue(json.contains(" \"uri\": { \"kind\": \"attribute\", \"required\": \"true\", \"type\": \"string\", \"javaType\": \"java.lang.String\"," + " \"deprecated\": \"false\", \"value\": \"direct:${header.whereto}\""));
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from("direct:start").wireTap("direct:${header.whereto}").id("mysend");
        from("direct:foo").to("mock:foo");
        from("direct:bar").to("mock:bar");
      }
    }
;
  }
}
