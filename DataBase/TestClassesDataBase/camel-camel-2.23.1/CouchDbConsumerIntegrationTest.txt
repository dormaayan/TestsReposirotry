public class CouchDbConsumerIntegrationTest extends CamelTestSupport {
  @EndpointInject(uri="couchdb:http://localhost:5984/camelcouchdb?deletes=false") private Endpoint from;
  @EndpointInject(uri="mock:result") private MockEndpoint to;
  private CouchDbClient client;
  @Before public void before(){
    client=new CouchDbClient("camelcouchdb",true,"http","localhost",5984,null,null);
  }
  @Override protected RouteBuilder createRouteBuilder() throws Exception {
    return new RouteBuilder(){
      @Override public void configure() throws Exception {
        from(from).to(to);
      }
    }
;
  }
  @Test public void testInsertsOnly() throws InterruptedException {
    to.expectedHeaderReceived(CouchDbConstants.HEADER_METHOD,"UPDATE");
    to.expectedMessageCount(1);
    JsonElement obj=new Gson().toJsonTree("{ \"randomString\" : \"" + UUID.randomUUID() + "\" }");
    Response resp=client.save(obj);
    client.remove(resp.getId(),resp.getRev());
    to.assertIsSatisfied();
  }
  @Test public void testMessages() throws InterruptedException {
    final int messageCount=100;
    to.expectedMessageCount(messageCount);
    Thread t=new Thread(new Runnable(){
      @Override public void run(){
        for (int k=0; k < messageCount; k++) {
          JsonElement obj=new Gson().toJsonTree("{ \"randomString\" : \"" + UUID.randomUUID() + "\" }");
          client.save(obj);
        }
      }
    }
);
    t.start();
    t.join();
    to.assertIsSatisfied();
  }
}
