/** 
 * Unit testing for using a MinaProducer that it can shutdown properly (CAMEL-395)
 */
public class Mina2ProducerShutdownMockTest extends BaseMina2Test {
  @Test public void testProducerShutdownTestingWithMock() throws Exception {
    MockEndpoint mock=getMockEndpoint("mock:result");
    mock.expectedBodiesReceived("Hello World");
    SocketConnector mockConnector=mock(SocketConnector.class);
    Endpoint endpoint=context.getEndpoint(String.format("mina2:tcp://localhost:%1$s?textline=true&sync=false",getPort()));
    Exchange exchange=endpoint.createExchange();
    Producer producer=endpoint.createProducer();
    producer.start();
    exchange.getIn().setBody("Hello World");
    producer.process(exchange);
    Field field=producer.getClass().getDeclaredField("connector");
    field.setAccessible(true);
    field.set(producer,mockConnector);
    Thread.sleep(1000);
    producer.stop();
    verify(mockConnector).dispose(true);
    assertMockEndpointsSatisfied();
  }
  protected RouteBuilder createRouteBuilder(){
    return new RouteBuilder(){
      public void configure(){
        from(String.format("mina2:tcp://localhost:%1$s?textline=true&sync=false",getPort())).to("mock:result");
      }
    }
;
  }
}
