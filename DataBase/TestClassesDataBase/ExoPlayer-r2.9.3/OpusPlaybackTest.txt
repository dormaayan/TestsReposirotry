/** 
 * Playback tests using  {@link LibopusAudioRenderer}. 
 */
@RunWith(AndroidJUnit4.class) public class OpusPlaybackTest {
  private static final String BEAR_OPUS_URI="asset:///bear-opus.webm";
  @Before public void setUp(){
    if (!OpusLibrary.isAvailable()) {
      fail("Opus library not available.");
    }
  }
  @Test public void testBasicPlayback() throws Exception {
    playUri(BEAR_OPUS_URI);
  }
  private void playUri(  String uri) throws Exception {
    TestPlaybackRunnable testPlaybackRunnable=new TestPlaybackRunnable(Uri.parse(uri),getContext());
    Thread thread=new Thread(testPlaybackRunnable);
    thread.start();
    thread.join();
    if (testPlaybackRunnable.playbackException != null) {
      throw testPlaybackRunnable.playbackException;
    }
  }
private static class TestPlaybackRunnable implements Player.EventListener, Runnable {
    private final Context context;
    private final Uri uri;
    private ExoPlayer player;
    private ExoPlaybackException playbackException;
    public TestPlaybackRunnable(    Uri uri,    Context context){
      this.uri=uri;
      this.context=context;
    }
    @Override public void run(){
      Looper.prepare();
      LibopusAudioRenderer audioRenderer=new LibopusAudioRenderer();
      DefaultTrackSelector trackSelector=new DefaultTrackSelector();
      player=ExoPlayerFactory.newInstance(new Renderer[]{audioRenderer},trackSelector);
      player.addListener(this);
      MediaSource mediaSource=new ExtractorMediaSource.Factory(new DefaultDataSourceFactory(context,"ExoPlayerExtOpusTest")).setExtractorsFactory(MatroskaExtractor.FACTORY).createMediaSource(uri);
      player.prepare(mediaSource);
      player.setPlayWhenReady(true);
      Looper.loop();
    }
    @Override public void onPlayerError(    ExoPlaybackException error){
      playbackException=error;
    }
    @Override public void onPlayerStateChanged(    boolean playWhenReady,    int playbackState){
      if (playbackState == Player.STATE_ENDED || (playbackState == Player.STATE_IDLE && playbackException != null)) {
        player.release();
        Looper.myLooper().quit();
      }
    }
  }
}
