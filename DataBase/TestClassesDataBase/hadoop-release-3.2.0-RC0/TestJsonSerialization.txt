/** 
 * Test the JSON serialization helper.
 */
public class TestJsonSerialization extends HadoopTestBase {
  private final JsonSerialization<KeyVal> serDeser=new JsonSerialization<>(KeyVal.class,true,true);
  private final KeyVal source=new KeyVal("key","1");
private static class KeyVal implements Serializable {
    private String name;
    private String value;
    KeyVal(    String name,    String value){
      this.name=name;
      this.value=value;
    }
    KeyVal(){
    }
    @Override public String toString(){
      final StringBuilder sb=new StringBuilder("SimpleJson{");
      sb.append("name='").append(name).append('\'');
      sb.append(", value='").append(value).append('\'');
      sb.append('}');
      return sb.toString();
    }
    @Override public boolean equals(    Object o){
      if (this == o) {
        return true;
      }
      if (o == null || getClass() != o.getClass()) {
        return false;
      }
      KeyVal that=(KeyVal)o;
      return Objects.equals(name,that.name) && Objects.equals(value,that.value);
    }
    @Override public int hashCode(){
      return Objects.hash(name,value);
    }
    public String getName(){
      return name;
    }
    public void setName(    String name){
      this.name=name;
    }
    public String getValue(){
      return value;
    }
    public void setValue(    String value){
      this.value=value;
    }
  }
  @Test public void testStringRoundTrip() throws Throwable {
    String wire=serDeser.toJson(source);
    KeyVal unmarshalled=serDeser.fromJson(wire);
    assertEquals("Failed to unmarshall: " + wire,source,unmarshalled);
  }
  @Test public void testBytesRoundTrip() throws Throwable {
    byte[] wire=serDeser.toBytes(source);
    KeyVal unmarshalled=serDeser.fromBytes(wire);
    assertEquals(source,unmarshalled);
  }
  @Test public void testBadBytesRoundTrip() throws Throwable {
    LambdaTestUtils.intercept(JsonParseException.class,"token",() -> serDeser.fromBytes(new byte[]{'a'}));
  }
  @Test public void testCloneViaJson() throws Throwable {
    KeyVal unmarshalled=serDeser.fromInstance(source);
    assertEquals(source,unmarshalled);
  }
  @Test public void testFileRoundTrip() throws Throwable {
    File tempFile=File.createTempFile("Keyval",".json");
    tempFile.delete();
    try {
      serDeser.save(tempFile,source);
      assertEquals(source,serDeser.load(tempFile));
    }
  finally {
      tempFile.delete();
    }
  }
  @Test public void testEmptyFile() throws Throwable {
    File tempFile=File.createTempFile("Keyval",".json");
    try {
      LambdaTestUtils.intercept(EOFException.class,"empty",() -> serDeser.load(tempFile));
    }
  finally {
      tempFile.delete();
    }
  }
  @Test public void testFileSystemRoundTrip() throws Throwable {
    File tempFile=File.createTempFile("Keyval",".json");
    tempFile.delete();
    Path tempPath=new Path(tempFile.toURI());
    LocalFileSystem fs=FileSystem.getLocal(new Configuration());
    try {
      serDeser.save(fs,tempPath,source,false);
      assertEquals(source,serDeser.load(fs,tempPath));
    }
  finally {
      fs.delete(tempPath,false);
    }
  }
  @Test public void testFileSystemEmptyPath() throws Throwable {
    File tempFile=File.createTempFile("Keyval",".json");
    Path tempPath=new Path(tempFile.toURI());
    LocalFileSystem fs=FileSystem.getLocal(new Configuration());
    try {
      LambdaTestUtils.intercept(EOFException.class,() -> serDeser.load(fs,tempPath));
      fs.delete(tempPath,false);
      LambdaTestUtils.intercept(FileNotFoundException.class,() -> serDeser.load(fs,tempPath));
    }
  finally {
      fs.delete(tempPath,false);
    }
  }
}
