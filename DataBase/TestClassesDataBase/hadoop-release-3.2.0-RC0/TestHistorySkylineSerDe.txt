/** 
 * Test HistorySkylineSerDe.
 */
public class TestHistorySkylineSerDe {
  /** 
 * Testing variables.
 */
  private Gson gson;
  private ResourceSkyline resourceSkyline;
  private Resource resource;
  private Resource resource2;
  private TreeMap<Long,Resource> resourceOverTime;
  private RLESparseResourceAllocation skylineList;
  @Before public final void setup(){
    resourceOverTime=new TreeMap<>();
    skylineList=new RLESparseResourceAllocation(resourceOverTime,new DefaultResourceCalculator());
    resource=Resource.newInstance(1024 * 100,100);
    resource2=Resource.newInstance(1024 * 200,200);
    gson=new GsonBuilder().registerTypeAdapter(Resource.class,new ResourceSerDe()).registerTypeAdapter(RLESparseResourceAllocation.class,new RLESparseResourceAllocationSerDe()).enableComplexMapKeySerialization().create();
  }
  @Test public final void testSerialization(){
    ReservationInterval riAdd=new ReservationInterval(0,10);
    skylineList.addInterval(riAdd,resource);
    riAdd=new ReservationInterval(10,20);
    skylineList.addInterval(riAdd,resource2);
    resourceSkyline=new ResourceSkyline("1",1024.5,0,20,resource,skylineList);
    RecurrenceId recurrenceId=new RecurrenceId("FraudDetection","1");
    List<ResourceSkyline> listSkyline=new ArrayList<>();
    listSkyline.add(resourceSkyline);
    Map<RecurrenceId,List<ResourceSkyline>> historySkyline=new HashMap<RecurrenceId,List<ResourceSkyline>>();
    historySkyline.put(recurrenceId,listSkyline);
    final String json=gson.toJson(historySkyline,new TypeToken<Map<RecurrenceId,List<ResourceSkyline>>>(){
    }
.getType());
    final Map<RecurrenceId,List<ResourceSkyline>> historySkylineDe=gson.fromJson(json,new TypeToken<Map<RecurrenceId,List<ResourceSkyline>>>(){
    }
.getType());
    List<ResourceSkyline> resourceSkylineList=historySkylineDe.get(recurrenceId);
    Assert.assertNotNull(resourceSkylineList);
    Assert.assertEquals(1,resourceSkylineList.size());
    ResourceSkyline resourceSkylineDe=resourceSkylineList.get(0);
    Assert.assertEquals(resourceSkylineDe.getJobId(),resourceSkyline.getJobId());
    Assert.assertEquals(resourceSkylineDe.getJobInputDataSize(),resourceSkyline.getJobInputDataSize(),0);
    Assert.assertEquals(resourceSkylineDe.getJobSubmissionTime(),resourceSkyline.getJobSubmissionTime());
    Assert.assertEquals(resourceSkylineDe.getJobFinishTime(),resourceSkyline.getJobFinishTime());
    Assert.assertEquals(resourceSkylineDe.getContainerSpec().getMemorySize(),resourceSkyline.getContainerSpec().getMemorySize());
    Assert.assertEquals(resourceSkylineDe.getContainerSpec().getVirtualCores(),resourceSkyline.getContainerSpec().getVirtualCores());
    final RLESparseResourceAllocation skylineList2=resourceSkyline.getSkylineList();
    final RLESparseResourceAllocation skylineListDe=resourceSkylineDe.getSkylineList();
    for (int i=0; i < 20; i++) {
      Assert.assertEquals(skylineList2.getCapacityAtTime(i).getMemorySize(),skylineListDe.getCapacityAtTime(i).getMemorySize());
      Assert.assertEquals(skylineList2.getCapacityAtTime(i).getVirtualCores(),skylineListDe.getCapacityAtTime(i).getVirtualCores());
    }
  }
  @After public final void cleanUp(){
    gson=null;
    resourceSkyline=null;
    resourceOverTime.clear();
    resourceOverTime=null;
    resource=null;
    resource2=null;
    skylineList=null;
  }
}
