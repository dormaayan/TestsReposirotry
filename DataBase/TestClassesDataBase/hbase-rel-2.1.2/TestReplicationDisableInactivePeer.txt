@Category({ReplicationTests.class,LargeTests.class}) public class TestReplicationDisableInactivePeer extends TestReplicationBase {
  @ClassRule public static final HBaseClassTestRule CLASS_RULE=HBaseClassTestRule.forClass(TestReplicationDisableInactivePeer.class);
  private static final Logger LOG=LoggerFactory.getLogger(TestReplicationDisableInactivePeer.class);
  /** 
 * Test disabling an inactive peer. Add a peer which is inactive, trying to insert, disable the peer, then activate the peer and make sure nothing is replicated. In Addition, enable the peer and check the updates are replicated.
 * @throws Exception
 */
  @Test public void testDisableInactivePeer() throws Exception {
    utility2.shutdownMiniHBaseCluster();
    byte[] rowkey=Bytes.toBytes("disable inactive peer");
    Put put=new Put(rowkey);
    put.addColumn(famName,row,row);
    htable1.put(put);
    Thread.sleep(SLEEP_TIME * NB_RETRIES);
    admin.disablePeer("2");
    utility2.startMiniHBaseCluster(1,2);
    Get get=new Get(rowkey);
    for (int i=0; i < NB_RETRIES; i++) {
      Result res=htable2.get(get);
      if (res.size() >= 1) {
        fail("Replication wasn't disabled");
      }
 else {
        LOG.info("Row not replicated, let's wait a bit more...");
        Thread.sleep(SLEEP_TIME);
      }
    }
    admin.enablePeer("2");
    Thread.sleep(SLEEP_TIME * NB_RETRIES);
    for (int i=0; i < NB_RETRIES; i++) {
      Result res=htable2.get(get);
      if (res.isEmpty()) {
        LOG.info("Row not available");
        Thread.sleep(SLEEP_TIME * NB_RETRIES);
      }
 else {
        assertArrayEquals(row,res.value());
        return;
      }
    }
    fail("Waited too much time for put replication");
  }
}
