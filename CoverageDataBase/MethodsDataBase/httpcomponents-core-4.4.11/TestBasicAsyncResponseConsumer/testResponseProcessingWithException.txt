@Test public void testResponseProcessingWithException() throws Exception {
  when(response.getEntity()).thenReturn(new StringEntity("stuff"));
  final RuntimeException ooopsie=new RuntimeException();
  when(consumer.buildResult(context)).thenThrow(ooopsie);
  consumer.responseReceived(response);
  consumer.consumeContent(decoder,ioControl);
  consumer.responseCompleted(context);
  verify(consumer).releaseResources();
  Assert.assertTrue(consumer.isDone());
  Assert.assertSame(ooopsie,consumer.getException());
}
