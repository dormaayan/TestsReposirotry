@SuppressWarnings({"rawtypes","unchecked"}) @Test public void testPooledRequestExecutionCancelled() throws Exception {
  final HttpHost host=new HttpHost("somehost");
  Mockito.when(this.requestProducer.getTarget()).thenReturn(host);
  Mockito.when(this.conn.isOpen()).thenReturn(true);
  final Future<Object> future=this.requester.execute(this.requestProducer,this.responseConsumer,this.connPool,this.exchangeContext,this.callback);
  Assert.assertNotNull(future);
  final ArgumentCaptor<FutureCallback> argCaptor=ArgumentCaptor.forClass(FutureCallback.class);
  Mockito.verify(this.connPool).lease(Matchers.eq(host),Matchers.isNull(),argCaptor.capture());
  final ConnRequestCallback connRequestCallback=(ConnRequestCallback)argCaptor.getValue();
  final BasicNIOPoolEntry entry=new BasicNIOPoolEntry("id",host,this.conn);
  connRequestCallback.completed(entry);
  final BasicAsyncClientExchangeHandler exchangeHandler=(BasicAsyncClientExchangeHandler)this.connContext.getAttribute(HttpAsyncRequestExecutor.HTTP_HANDLER);
  Assert.assertNotNull(exchangeHandler);
  Mockito.verify(this.conn).requestOutput();
  exchangeHandler.cancel();
  Mockito.verify(this.responseConsumer).cancel();
  Mockito.verify(this.callback).cancelled();
  Mockito.verify(this.responseConsumer).close();
  Mockito.verify(this.requestProducer).close();
  Mockito.verify(this.connPool).release(entry,false);
}
