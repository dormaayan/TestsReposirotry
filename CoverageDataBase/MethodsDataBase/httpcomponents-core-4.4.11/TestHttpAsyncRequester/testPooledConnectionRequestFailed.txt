@SuppressWarnings({"rawtypes"}) @Test public void testPooledConnectionRequestFailed() throws Exception {
  final HttpHost host=new HttpHost("somehost");
  Mockito.when(this.requestProducer.getTarget()).thenReturn(host);
  final Future<Object> future=this.requester.execute(this.requestProducer,this.responseConsumer,this.connPool,this.exchangeContext,this.callback);
  Assert.assertNotNull(future);
  final ArgumentCaptor<FutureCallback> argCaptor=ArgumentCaptor.forClass(FutureCallback.class);
  Mockito.verify(this.connPool).lease(Matchers.eq(host),Matchers.isNull(),argCaptor.capture());
  final ConnRequestCallback connRequestCallback=(ConnRequestCallback)argCaptor.getValue();
  final Exception oppsie=new Exception();
  connRequestCallback.failed(oppsie);
  Mockito.verify(this.responseConsumer).failed(oppsie);
  Mockito.verify(this.callback).failed(oppsie);
  Mockito.verify(this.responseConsumer).close();
  Mockito.verify(this.requestProducer).close();
}
