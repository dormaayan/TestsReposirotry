@Test public void testEarlyResponse() throws Exception {
  final State state=new HttpAsyncRequestExecutor.State();
  state.setRequestState(MessageState.BODY_STREAM);
  state.setTimeout(1000);
  final BasicHttpEntityEnclosingRequest request=new BasicHttpEntityEnclosingRequest("POST","/");
  request.setEntity(new NStringEntity("stuff"));
  state.setRequest(request);
  this.connContext.setAttribute(HttpAsyncRequestExecutor.HTTP_EXCHANGE_STATE,state);
  this.connContext.setAttribute(HttpAsyncRequestExecutor.HTTP_HANDLER,this.exchangeHandler);
  final BasicHttpResponse response=new BasicHttpResponse(HttpVersion.HTTP_1_1,403,"Unauthorized");
  Mockito.when(this.conn.getHttpResponse()).thenReturn(response);
  this.protocolHandler.responseReceived(this.conn);
  Assert.assertSame(response,state.getResponse());
  Assert.assertEquals(MessageState.COMPLETED,state.getRequestState());
  Assert.assertEquals(MessageState.BODY_STREAM,state.getResponseState());
  Mockito.verify(this.conn).suspendOutput();
  Mockito.verify(this.conn).resetOutput();
  Assert.assertFalse(state.isValid());
}
