@Test public void testUnsupportedHttpVersionException() throws Exception {
  final HttpProcessor httprocessor=Mockito.mock(HttpProcessor.class);
  final ConnectionReuseStrategy connReuseStrategy=Mockito.mock(ConnectionReuseStrategy.class);
  final HttpResponseFactory responseFactory=Mockito.mock(HttpResponseFactory.class);
  final HttpRequestHandlerMapper handlerResolver=Mockito.mock(HttpRequestHandlerMapper.class);
  final HttpRequestHandler requestHandler=Mockito.mock(HttpRequestHandler.class);
  final HttpService httpservice=new HttpService(httprocessor,connReuseStrategy,responseFactory,handlerResolver);
  final HttpCoreContext context=HttpCoreContext.create();
  final HttpServerConnection conn=Mockito.mock(HttpServerConnection.class);
  final HttpRequest request=new BasicHttpRequest("whatever","/");
  Mockito.when(conn.receiveRequestHeader()).thenReturn(request);
  final HttpResponse response=new BasicHttpResponse(HttpVersion.HTTP_1_1,200,"OK");
  Mockito.when(responseFactory.newHttpResponse(HttpVersion.HTTP_1_1,200,context)).thenReturn(response);
  final HttpResponse error=new BasicHttpResponse(HttpVersion.HTTP_1_0,500,"Oppsie");
  Mockito.when(responseFactory.newHttpResponse(HttpVersion.HTTP_1_0,500,context)).thenReturn(error);
  Mockito.when(handlerResolver.lookup(request)).thenReturn(requestHandler);
  Mockito.doThrow(new UnsupportedHttpVersionException()).when(requestHandler).handle(request,response,context);
  Mockito.when(connReuseStrategy.keepAlive(error,context)).thenReturn(Boolean.FALSE);
  httpservice.handleRequest(conn,context);
  Assert.assertSame(conn,context.getConnection());
  Assert.assertSame(request,context.getRequest());
  Assert.assertSame(error,context.getResponse());
  Assert.assertEquals(HttpStatus.SC_HTTP_VERSION_NOT_SUPPORTED,error.getStatusLine().getStatusCode());
  Mockito.verify(conn).sendResponseHeader(error);
  Mockito.verify(httprocessor).process(error,context);
  Mockito.verify(conn).sendResponseHeader(error);
  Mockito.verify(conn).sendResponseEntity(error);
  Mockito.verify(conn).flush();
  Mockito.verify(conn).close();
}
