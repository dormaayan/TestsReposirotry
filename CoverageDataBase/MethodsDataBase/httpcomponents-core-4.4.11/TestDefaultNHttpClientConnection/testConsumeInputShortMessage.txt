@Test public void testConsumeInputShortMessage() throws Exception {
  final ReadableByteChannelMock rchannel=Mockito.spy(new ReadableByteChannelMock(new String[]{"HTTP/1.1 200 OK\r\nContent-Length: 5\r\n\r\nstuff"},Consts.ASCII));
  final ByteChannelMock channel=new ByteChannelMock(rchannel,null);
  Mockito.when(session.channel()).thenReturn(channel);
  Mockito.when(session.getEventMask()).thenReturn(SelectionKey.OP_READ);
  final LinkedList<HttpResponse> responses=new LinkedList<HttpResponse>();
  Mockito.doAnswer(new ResponseCapturingAnswer(responses)).when(handler).responseReceived(Matchers.<NHttpClientConnection>any());
  Mockito.doAnswer(new ConsumeContentAnswer(new SimpleInputBuffer(64))).when(handler).inputReady(Matchers.<NHttpClientConnection>any(),Matchers.<ContentDecoder>any());
  Assert.assertEquals(0,conn.getMetrics().getResponseCount());
  conn.consumeInput(handler);
  Assert.assertNull(conn.getHttpResponse());
  Assert.assertNull(conn.contentDecoder);
  Assert.assertEquals(1,conn.getMetrics().getResponseCount());
  Assert.assertEquals(43,conn.getMetrics().getReceivedBytesCount());
  Mockito.verify(handler,Mockito.times(1)).responseReceived(Matchers.<NHttpClientConnection>any());
  Mockito.verify(handler,Mockito.times(1)).inputReady(Matchers.<NHttpClientConnection>any(),Matchers.<LengthDelimitedDecoder>any());
  Mockito.verify(rchannel,Mockito.times(2)).read(Matchers.<ByteBuffer>any());
  Mockito.verify(handler,Mockito.never()).exception(Matchers.<NHttpClientConnection>any(),Matchers.<Exception>any());
  Assert.assertFalse(responses.isEmpty());
  final HttpResponse response=responses.getFirst();
  Assert.assertNotNull(response);
  Assert.assertEquals(HttpVersion.HTTP_1_1,response.getStatusLine().getProtocolVersion());
  Assert.assertEquals(200,response.getStatusLine().getStatusCode());
  Assert.assertEquals("OK",response.getStatusLine().getReasonPhrase());
  final HttpEntity entity=response.getEntity();
  Assert.assertNotNull(entity);
  Assert.assertEquals(5,entity.getContentLength());
}
