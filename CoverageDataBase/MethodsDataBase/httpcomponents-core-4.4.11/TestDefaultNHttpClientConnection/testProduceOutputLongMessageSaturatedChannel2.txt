@Test public void testProduceOutputLongMessageSaturatedChannel2() throws Exception {
  conn=new DefaultNHttpClientConnection(session,24);
  final BasicHttpEntityEnclosingRequest request=new BasicHttpEntityEnclosingRequest("POST","/");
  final NStringEntity entity=new NStringEntity("a loooooooooooooooooooooooot of various stuff");
  request.setEntity(entity);
  final WritableByteChannelMock wchannel=Mockito.spy(new WritableByteChannelMock(64,24));
  final ByteChannelMock channel=new ByteChannelMock(null,wchannel);
  Mockito.when(session.channel()).thenReturn(channel);
  Mockito.doAnswer(new RequestReadyAnswer(request)).when(handler).requestReady(Matchers.<NHttpClientConnection>any());
  Mockito.doAnswer(new ProduceContentAnswer(entity)).when(handler).outputReady(Matchers.<NHttpClientConnection>any(),Matchers.<ContentEncoder>any());
  conn.produceOutput(handler);
  Assert.assertNotNull(conn.getHttpRequest());
  Assert.assertNotNull(conn.contentEncoder);
  Assert.assertEquals("POST / HTTP/1.1\r\n\r\na loo",wchannel.dump(Consts.ASCII));
  Mockito.verify(session,Mockito.never()).clearEvent(SelectionKey.OP_WRITE);
  Mockito.verify(wchannel,Mockito.times(3)).write(Matchers.<ByteBuffer>any());
}
