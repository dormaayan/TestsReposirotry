@Test public void testConsumeInputLongMessage() throws Exception {
  conn=new DefaultNHttpServerConnection(session,1024);
  final ReadableByteChannelMock rchannel=Mockito.spy(new ReadableByteChannelMock(new String[]{"POST / HTTP/1.1\r\nContent-Length: 100\r\n\r\na lot of stuff","",""},Consts.ASCII));
  final ByteChannelMock channel=new ByteChannelMock(rchannel,null);
  Mockito.when(session.channel()).thenReturn(channel);
  Mockito.when(session.getEventMask()).thenReturn(SelectionKey.OP_READ);
  final LinkedList<HttpRequest> requests=new LinkedList<HttpRequest>();
  Mockito.doAnswer(new RequestCapturingAnswer(requests)).when(handler).requestReceived(Matchers.<NHttpServerConnection>any());
  Mockito.doAnswer(new ConsumeContentAnswer(new SimpleInputBuffer(64))).when(handler).inputReady(Matchers.<NHttpServerConnection>any(),Matchers.<ContentDecoder>any());
  Assert.assertEquals(0,conn.getMetrics().getResponseCount());
  conn.consumeInput(handler);
  Assert.assertNotNull(conn.getHttpRequest());
  Assert.assertNotNull(conn.contentDecoder);
  Assert.assertEquals(1,conn.getMetrics().getRequestCount());
  Assert.assertEquals(54,conn.getMetrics().getReceivedBytesCount());
  Mockito.verify(handler,Mockito.times(1)).requestReceived(Matchers.<NHttpServerConnection>any());
  Mockito.verify(handler,Mockito.times(1)).inputReady(Matchers.<NHttpServerConnection>any(),Matchers.<LengthDelimitedDecoder>any());
  Mockito.verify(rchannel,Mockito.times(2)).read(Matchers.<ByteBuffer>any());
  Mockito.verify(handler,Mockito.never()).exception(Matchers.<NHttpServerConnection>any(),Matchers.<Exception>any());
  Assert.assertFalse(requests.isEmpty());
  final HttpRequest request=requests.getFirst();
  Assert.assertNotNull(request);
  Assert.assertEquals(HttpVersion.HTTP_1_1,request.getRequestLine().getProtocolVersion());
  Assert.assertEquals("POST",request.getRequestLine().getMethod());
  Assert.assertEquals("/",request.getRequestLine().getUri());
  Assert.assertTrue(request instanceof HttpEntityEnclosingRequest);
  final HttpEntity entity=((HttpEntityEnclosingRequest)request).getEntity();
  Assert.assertNotNull(entity);
  Assert.assertEquals(100,entity.getContentLength());
  conn.consumeInput(handler);
  Assert.assertEquals(1,conn.getMetrics().getRequestCount());
  Assert.assertEquals(54,conn.getMetrics().getReceivedBytesCount());
  Mockito.verify(rchannel,Mockito.times(3)).read(Matchers.<ByteBuffer>any());
  Mockito.verify(handler,Mockito.never()).exception(Matchers.<NHttpServerConnection>any(),Matchers.<Exception>any());
}
