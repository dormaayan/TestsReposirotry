@Test public void testProduceOutputClosingConnection() throws Exception {
  final BasicHttpResponse response=new BasicHttpResponse(HttpVersion.HTTP_1_1,200,"OK");
  final WritableByteChannelMock wchannel=Mockito.spy(new WritableByteChannelMock(64));
  final ByteChannelMock channel=new ByteChannelMock(null,wchannel);
  Mockito.when(session.channel()).thenReturn(channel);
  conn.submitResponse(response);
  conn.close();
  Assert.assertEquals(NHttpConnection.CLOSING,conn.getStatus());
  conn.produceOutput(handler);
  Assert.assertEquals(NHttpConnection.CLOSED,conn.getStatus());
  Mockito.verify(wchannel,Mockito.times(1)).write(Matchers.<ByteBuffer>any());
  Mockito.verify(session,Mockito.times(1)).close();
  Mockito.verify(session,Mockito.never()).clearEvent(SelectionKey.OP_WRITE);
  Mockito.verify(handler,Mockito.never()).responseReady(Matchers.<NHttpServerConnection>any());
  Mockito.verify(handler,Mockito.never()).outputReady(Matchers.<NHttpServerConnection>any(),Matchers.<ContentEncoder>any());
}
