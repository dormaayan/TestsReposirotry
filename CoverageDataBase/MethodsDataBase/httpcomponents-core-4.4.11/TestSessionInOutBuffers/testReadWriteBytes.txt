@Test public void testReadWriteBytes() throws Exception {
  final byte[] out=new byte[40];
  for (int i=0; i < out.length; i++) {
    out[i]=(byte)('0' + i);
  }
  final SessionOutputBufferMock outbuffer=new SessionOutputBufferMock();
  int off=0;
  int remaining=out.length;
  while (remaining > 0) {
    int chunk=10;
    if (chunk > remaining) {
      chunk=remaining;
    }
    outbuffer.write(out,off,chunk);
    off+=chunk;
    remaining-=chunk;
  }
  outbuffer.flush();
  final long bytesWritten=outbuffer.getMetrics().getBytesTransferred();
  Assert.assertEquals(out.length,bytesWritten);
  final byte[] tmp=outbuffer.getData();
  Assert.assertEquals(out.length,tmp.length);
  for (int i=0; i < out.length; i++) {
    Assert.assertEquals(out[i],tmp[i]);
  }
  final SessionInputBufferMock inBuffer=new SessionInputBufferMock(tmp);
  Assert.assertEquals(0,inBuffer.read(null,0,10));
  Assert.assertEquals(0,inBuffer.read(null));
  long bytesRead=inBuffer.getMetrics().getBytesTransferred();
  Assert.assertEquals(0,bytesRead);
  final byte[] in=new byte[40];
  off=0;
  remaining=in.length;
  while (remaining > 0) {
    int chunk=10;
    if (chunk > remaining) {
      chunk=remaining;
    }
    final int readLen=inBuffer.read(in,off,chunk);
    if (readLen == -1) {
      break;
    }
    off+=readLen;
    remaining-=readLen;
  }
  for (int i=0; i < out.length; i++) {
    Assert.assertEquals(out[i],in[i]);
  }
  Assert.assertEquals(-1,inBuffer.read(tmp));
  Assert.assertEquals(-1,inBuffer.read(tmp));
  bytesRead=inBuffer.getMetrics().getBytesTransferred();
  Assert.assertEquals(out.length,bytesRead);
}
