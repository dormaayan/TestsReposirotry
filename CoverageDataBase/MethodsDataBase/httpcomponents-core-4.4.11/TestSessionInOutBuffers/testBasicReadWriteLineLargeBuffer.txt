@Test public void testBasicReadWriteLineLargeBuffer() throws Exception {
  final String[] teststrs=new String[5];
  teststrs[0]="Hello";
  teststrs[1]="This string should be much longer than the size of the output buffer " + "which is only 16 bytes for this test";
  final StringBuilder buffer=new StringBuilder();
  for (int i=0; i < 15; i++) {
    buffer.append("123456789 ");
  }
  buffer.append("and stuff like that");
  teststrs[2]=buffer.toString();
  teststrs[3]="";
  teststrs[4]="And goodbye";
  final CharArrayBuffer chbuffer=new CharArrayBuffer(16);
  final SessionOutputBufferMock outbuffer=new SessionOutputBufferMock();
  for (  final String teststr : teststrs) {
    chbuffer.clear();
    chbuffer.append(teststr);
    outbuffer.writeLine(chbuffer);
  }
  outbuffer.writeLine((String)null);
  outbuffer.writeLine((CharArrayBuffer)null);
  outbuffer.flush();
  final long bytesWritten=outbuffer.getMetrics().getBytesTransferred();
  long expected=0;
  for (  final String teststr : teststrs) {
    expected+=(teststr.length() + 2);
  }
  Assert.assertEquals(expected,bytesWritten);
  final SessionInputBufferMock inBuffer=new SessionInputBufferMock(outbuffer.getData(),1024);
  for (  final String teststr : teststrs) {
    Assert.assertEquals(teststr,inBuffer.readLine());
  }
  Assert.assertNull(inBuffer.readLine());
  Assert.assertNull(inBuffer.readLine());
  final long bytesRead=inBuffer.getMetrics().getBytesTransferred();
  Assert.assertEquals(expected,bytesRead);
}
