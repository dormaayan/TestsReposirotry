@Test public void testRequestExpectationNoHandshakeIfMoreInputAvailable() throws Exception {
  final State state=new State();
  state.setRequestState(MessageState.READY);
  state.setResponseState(MessageState.READY);
  this.connContext.setAttribute(HttpAsyncService.HTTP_EXCHANGE_STATE,state);
  this.conn=Mockito.mock(NHttpServerConnection.class,Mockito.withSettings().extraInterfaces(SessionBufferStatus.class));
  final HttpEntityEnclosingRequest request=new BasicHttpEntityEnclosingRequest("POST","/",HttpVersion.HTTP_1_1);
  request.addHeader(HTTP.EXPECT_DIRECTIVE,HTTP.EXPECT_CONTINUE);
  Mockito.when(this.conn.getContext()).thenReturn(this.connContext);
  Mockito.when(this.conn.getHttpRequest()).thenReturn(request);
  Mockito.when(this.requestHandler.processRequest(Matchers.eq(request),Matchers.any(HttpContext.class))).thenReturn(this.requestConsumer);
  Mockito.when(((SessionBufferStatus)this.conn).hasBufferedInput()).thenReturn(Boolean.TRUE);
  this.protocolHandler.requestReceived(this.conn);
  Mockito.verify(this.requestConsumer).requestReceived(request);
  Assert.assertEquals(MessageState.BODY_STREAM,state.getRequestState());
  Assert.assertEquals(MessageState.READY,state.getResponseState());
}
