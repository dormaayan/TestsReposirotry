@Test public void testCloseWithBufferedData() throws Exception {
  final InetSocketAddress local=new InetSocketAddress(InetAddress.getByAddress(new byte[]{127,0,0,1}),8888);
  final InetSocketAddress remote=new InetSocketAddress(InetAddress.getByAddress(new byte[]{10,0,0,2}),80);
  Mockito.when(session.getLocalAddress()).thenReturn(local);
  Mockito.when(session.getRemoteAddress()).thenReturn(remote);
  Mockito.when(session.isClosed()).thenReturn(Boolean.FALSE);
  conn.outbuf.writeLine("stuff");
  conn.close();
  Assert.assertEquals(NHttpConnection.CLOSING,conn.getStatus());
  conn.close();
  Assert.assertEquals(NHttpConnection.CLOSING,conn.getStatus());
  Assert.assertEquals("127.0.0.1:8888<->10.0.0.2:80",conn.toString());
  Mockito.verify(session).setEvent(SelectionKey.OP_WRITE);
  Mockito.verify(session,Mockito.never()).close();
}
