/** 
 * This test case executes a series of simple GET requests
 */
@Test public void testSimpleBasicHttpRequests() throws Exception {
  final int reqNo=20;
  final Random rnd=new Random();
  final List<byte[]> testData=new ArrayList<byte[]>(reqNo);
  for (int i=0; i < reqNo; i++) {
    final int size=rnd.nextInt(5000);
    final byte[] data=new byte[size];
    rnd.nextBytes(data);
    testData.add(data);
  }
  this.server.registerHandler("*",new HttpRequestHandler(){
    @Override public void handle(    final HttpRequest request,    final HttpResponse response,    final HttpContext context) throws HttpException, IOException {
      String s=request.getRequestLine().getUri();
      if (s.startsWith("/?")) {
        s=s.substring(2);
      }
      final int index=Integer.parseInt(s);
      final byte[] data=testData.get(index);
      final ByteArrayEntity entity=new ByteArrayEntity(data);
      response.setEntity(entity);
    }
  }
);
  this.server.start();
  final DefaultBHttpClientConnection conn=client.createConnection();
  final HttpHost host=new HttpHost("localhost",this.server.getPort());
  try {
    for (int r=0; r < reqNo; r++) {
      if (!conn.isOpen()) {
        client.connect(host,conn);
      }
      final BasicHttpRequest get=new BasicHttpRequest("GET","/?" + r);
      final HttpResponse response=this.client.execute(get,host,conn);
      final byte[] received=EntityUtils.toByteArray(response.getEntity());
      final byte[] expected=testData.get(r);
      Assert.assertEquals(expected.length,received.length);
      for (int i=0; i < expected.length; i++) {
        Assert.assertEquals(expected[i],received[i]);
      }
      if (!this.client.keepAlive(response)) {
        conn.close();
      }
    }
    final HttpConnectionMetrics cm=conn.getMetrics();
    Assert.assertEquals(reqNo,cm.getRequestCount());
    Assert.assertEquals(reqNo,cm.getResponseCount());
  }
  finally {
    conn.close();
    this.server.shutdown();
  }
}
