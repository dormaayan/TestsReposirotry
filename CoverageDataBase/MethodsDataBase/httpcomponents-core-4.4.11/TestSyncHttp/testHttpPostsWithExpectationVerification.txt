/** 
 * This test case executes a series of simple POST requests that do not meet the target server expectations.
 */
@Test public void testHttpPostsWithExpectationVerification() throws Exception {
  final int reqNo=3;
  this.server.registerHandler("*",new HttpRequestHandler(){
    @Override public void handle(    final HttpRequest request,    final HttpResponse response,    final HttpContext context) throws HttpException, IOException {
      final StringEntity outgoing=new StringEntity("No content");
      response.setEntity(outgoing);
    }
  }
);
  this.server.setExpectationVerifier(new HttpExpectationVerifier(){
    @Override public void verify(    final HttpRequest request,    final HttpResponse response,    final HttpContext context) throws HttpException {
      final Header someheader=request.getFirstHeader("Secret");
      if (someheader != null) {
        final int secretNumber;
        try {
          secretNumber=Integer.parseInt(someheader.getValue());
        }
 catch (        final NumberFormatException ex) {
          response.setStatusCode(HttpStatus.SC_BAD_REQUEST);
          return;
        }
        if (secretNumber < 2) {
          response.setStatusCode(HttpStatus.SC_EXPECTATION_FAILED);
          final ByteArrayEntity outgoing=new ByteArrayEntity(EncodingUtils.getAsciiBytes("Wrong secret number"));
          response.setEntity(outgoing);
        }
      }
    }
  }
);
  this.server.start();
  final DefaultBHttpClientConnection conn=client.createConnection();
  final HttpHost host=new HttpHost("localhost",this.server.getPort());
  try {
    for (int r=0; r < reqNo; r++) {
      if (!conn.isOpen()) {
        client.connect(host,conn);
      }
      final BasicHttpEntityEnclosingRequest post=new BasicHttpEntityEnclosingRequest("POST","/");
      post.addHeader("Secret",Integer.toString(r));
      final ByteArrayEntity outgoing=new ByteArrayEntity(EncodingUtils.getAsciiBytes("No content " + r));
      post.setEntity(outgoing);
      final HttpResponse response=this.client.execute(post,host,conn);
      final HttpEntity entity=response.getEntity();
      Assert.assertNotNull(entity);
      EntityUtils.consume(entity);
      if (r < 2) {
        Assert.assertEquals(HttpStatus.SC_EXPECTATION_FAILED,response.getStatusLine().getStatusCode());
      }
 else {
        Assert.assertEquals(HttpStatus.SC_OK,response.getStatusLine().getStatusCode());
      }
      if (!this.client.keepAlive(response)) {
        conn.close();
      }
    }
    final HttpConnectionMetrics cm=conn.getMetrics();
    Assert.assertEquals(reqNo,cm.getRequestCount());
    Assert.assertEquals(reqNo,cm.getResponseCount());
  }
  finally {
    conn.close();
    this.server.shutdown();
  }
}
