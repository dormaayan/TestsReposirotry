/** 
 * This test case executes a series of simple POST requests using the 'expect: continue' handshake.
 */
@Test public void testHttpPostsWithExpectContinue() throws Exception {
  final int reqNo=20;
  final Random rnd=new Random();
  final List<byte[]> testData=new ArrayList<byte[]>(reqNo);
  for (int i=0; i < reqNo; i++) {
    final int size=rnd.nextInt(5000);
    final byte[] data=new byte[size];
    rnd.nextBytes(data);
    testData.add(data);
  }
  this.server.registerHandler("*",new HttpRequestHandler(){
    @Override public void handle(    final HttpRequest request,    final HttpResponse response,    final HttpContext context) throws HttpException, IOException {
      if (request instanceof HttpEntityEnclosingRequest) {
        final HttpEntity incoming=((HttpEntityEnclosingRequest)request).getEntity();
        final byte[] data=EntityUtils.toByteArray(incoming);
        final ByteArrayEntity outgoing=new ByteArrayEntity(data);
        outgoing.setChunked(true);
        response.setEntity(outgoing);
      }
 else {
        final StringEntity outgoing=new StringEntity("No content");
        response.setEntity(outgoing);
      }
    }
  }
);
  this.server.start();
  final DefaultBHttpClientConnection conn=client.createConnection();
  final HttpHost host=new HttpHost("localhost",this.server.getPort());
  try {
    for (int r=0; r < reqNo; r++) {
      if (!conn.isOpen()) {
        client.connect(host,conn);
      }
      final BasicHttpEntityEnclosingRequest post=new BasicHttpEntityEnclosingRequest("POST","/");
      final byte[] data=testData.get(r);
      final ByteArrayEntity outgoing=new ByteArrayEntity(data);
      outgoing.setChunked(true);
      post.setEntity(outgoing);
      final HttpResponse response=this.client.execute(post,host,conn);
      final byte[] received=EntityUtils.toByteArray(response.getEntity());
      final byte[] expected=testData.get(r);
      Assert.assertEquals(expected.length,received.length);
      for (int i=0; i < expected.length; i++) {
        Assert.assertEquals(expected[i],received[i]);
      }
      if (!this.client.keepAlive(response)) {
        conn.close();
      }
    }
    final HttpConnectionMetrics cm=conn.getMetrics();
    Assert.assertEquals(reqNo,cm.getRequestCount());
    Assert.assertEquals(reqNo,cm.getResponseCount());
  }
  finally {
    conn.close();
    this.server.shutdown();
  }
}
