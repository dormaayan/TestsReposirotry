/** 
 * https://github.com/square/okhttp/issues/2788 
 */
@Test public void clientCancelsIfCloseIsNotAcknowledged(){
  webServer.enqueue(new MockResponse().withWebSocketUpgrade(serverListener));
  RealWebSocket webSocket=newWebSocket();
  clientListener.assertOpen();
  WebSocket server=serverListener.assertOpen();
  long closeAtNanos=System.nanoTime();
  webSocket.close(1000,"goodbye",500);
  serverListener.assertClosing(1000,"goodbye");
  clientListener.assertFailure();
  long elapsedUntilFailure=System.nanoTime() - closeAtNanos;
  assertEquals(500,TimeUnit.NANOSECONDS.toMillis(elapsedUntilFailure),250d);
  server.close(1000,null);
  serverListener.assertClosed(1000,"goodbye");
}
