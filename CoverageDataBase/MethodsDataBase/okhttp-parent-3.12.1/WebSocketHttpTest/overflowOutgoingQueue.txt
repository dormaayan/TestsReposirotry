@Test public void overflowOutgoingQueue(){
  webServer.enqueue(new MockResponse().withWebSocketUpgrade(serverListener));
  WebSocket webSocket=newWebSocket();
  clientListener.assertOpen();
  ByteString message=ByteString.of(new byte[1024 * 1024]);
  int messageCount=0;
  while (true) {
    boolean success=webSocket.send(message);
    if (!success)     break;
    messageCount++;
    long queueSize=webSocket.queueSize();
    assertTrue(queueSize >= 0 && queueSize <= messageCount * message.size());
    assertTrue(messageCount < 32);
  }
  WebSocket server=serverListener.assertOpen();
  for (int i=0; i < messageCount; i++) {
    serverListener.assertBinaryMessage(message);
  }
  serverListener.assertClosing(1001,"");
  server.close(1000,null);
  clientListener.assertClosing(1000,"");
  clientListener.assertClosed(1000,"");
  serverListener.assertClosed(1001,"");
}
