@Test public void conditionalCacheMiss() throws Exception {
  server.enqueue(new MockResponse().addHeader("ETag: v1").addHeader("Vary: Accept-Charset").addHeader("Donut: a").setBody("A"));
  server.enqueue(new MockResponse().addHeader("Donut: b").setBody("B"));
  client=client.newBuilder().cache(cache).build();
  long request1SentAt=System.currentTimeMillis();
  executeSynchronously("/","Accept-Language","fr-CA","Accept-Charset","UTF-8").assertCode(200).assertBody("A");
  long request1ReceivedAt=System.currentTimeMillis();
  assertNull(server.takeRequest().getHeader("If-None-Match"));
  Thread.sleep(10);
  long request2SentAt=System.currentTimeMillis();
  RecordedResponse cacheMiss=executeSynchronously("/","Accept-Language","en-US","Accept-Charset","UTF-8");
  long request2ReceivedAt=System.currentTimeMillis();
  assertEquals("v1",server.takeRequest().getHeader("If-None-Match"));
  cacheMiss.assertCode(200).assertBody("B").assertHeader("Donut","b").assertRequestUrl(server.url("/")).assertSentRequestAtMillis(request2SentAt,request2ReceivedAt).assertReceivedResponseAtMillis(request2SentAt,request2ReceivedAt);
  cacheMiss.cacheResponse().assertCode(200).assertHeader("Donut","a").assertHeader("ETag","v1").assertRequestUrl(server.url("/")).assertSentRequestAtMillis(request1SentAt,request1ReceivedAt).assertReceivedResponseAtMillis(request1SentAt,request1ReceivedAt);
  cacheMiss.networkResponse().assertCode(200).assertHeader("Donut","b").assertRequestHeader("If-None-Match","v1").assertRequestUrl(server.url("/")).assertSentRequestAtMillis(request2SentAt,request2ReceivedAt).assertReceivedResponseAtMillis(request2SentAt,request2ReceivedAt);
}
