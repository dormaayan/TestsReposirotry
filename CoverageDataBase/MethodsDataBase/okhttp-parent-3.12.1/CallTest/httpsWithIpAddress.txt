@Test public void httpsWithIpAddress() throws Exception {
  String localIpAddress=InetAddress.getLoopbackAddress().getHostAddress();
  HeldCertificate heldCertificate=new HeldCertificate.Builder().commonName("example.com").addSubjectAlternativeName(localIpAddress).build();
  HandshakeCertificates handshakeCertificates=new HandshakeCertificates.Builder().heldCertificate(heldCertificate).addTrustedCertificate(heldCertificate.certificate()).build();
  server.useHttps(handshakeCertificates.sslSocketFactory(),false);
  client=client.newBuilder().sslSocketFactory(handshakeCertificates.sslSocketFactory(),handshakeCertificates.trustManager()).hostnameVerifier(new RecordingHostnameVerifier()).protocols(Collections.singletonList(Protocol.HTTP_1_1)).build();
  server.enqueue(new MockResponse());
  HttpUrl url=server.url("/").newBuilder().host(localIpAddress).build();
  Request request=new Request.Builder().url(url).build();
  executeSynchronously(request).assertCode(200);
  RecordedRequest recordedRequest=server.takeRequest();
  assertEquals(localIpAddress + ":" + server.getPort(),recordedRequest.getHeader("Host"));
}
