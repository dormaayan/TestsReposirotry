@Test public void conditionalCacheHit() throws Exception {
  server.enqueue(new MockResponse().addHeader("ETag: v1").addHeader("Vary: Accept-Charset").addHeader("Donut: a").setBody("A"));
  server.enqueue(new MockResponse().clearHeaders().addHeader("Donut: b").setResponseCode(HttpURLConnection.HTTP_NOT_MODIFIED));
  client=client.newBuilder().cache(cache).build();
  long request1SentAt=System.currentTimeMillis();
  executeSynchronously("/","Accept-Language","fr-CA","Accept-Charset","UTF-8").assertCode(200).assertHeader("Donut","a").assertBody("A");
  long request1ReceivedAt=System.currentTimeMillis();
  assertNull(server.takeRequest().getHeader("If-None-Match"));
  Thread.sleep(10);
  long request2SentAt=System.currentTimeMillis();
  RecordedResponse cacheHit=executeSynchronously("/","Accept-Language","en-US","Accept-Charset","UTF-8");
  long request2ReceivedAt=System.currentTimeMillis();
  assertEquals("v1",server.takeRequest().getHeader("If-None-Match"));
  cacheHit.assertCode(200).assertBody("A").assertHeader("Donut","b").assertRequestUrl(server.url("/")).assertRequestHeader("Accept-Language","en-US").assertRequestHeader("Accept-Charset","UTF-8").assertRequestHeader("If-None-Match").assertSentRequestAtMillis(request2SentAt,request2ReceivedAt).assertReceivedResponseAtMillis(request2SentAt,request2ReceivedAt);
  cacheHit.cacheResponse().assertCode(200).assertHeader("Donut","a").assertHeader("ETag","v1").assertRequestUrl(server.url("/")).assertRequestHeader("Accept-Language").assertRequestHeader("Accept-Charset","UTF-8").assertRequestHeader("If-None-Match").assertSentRequestAtMillis(request1SentAt,request1ReceivedAt).assertReceivedResponseAtMillis(request1SentAt,request1ReceivedAt);
  cacheHit.networkResponse().assertCode(304).assertHeader("Donut","b").assertRequestHeader("Accept-Language","en-US").assertRequestHeader("Accept-Charset","UTF-8").assertRequestHeader("If-None-Match","v1").assertSentRequestAtMillis(request2SentAt,request2ReceivedAt).assertReceivedResponseAtMillis(request2SentAt,request2ReceivedAt);
}
