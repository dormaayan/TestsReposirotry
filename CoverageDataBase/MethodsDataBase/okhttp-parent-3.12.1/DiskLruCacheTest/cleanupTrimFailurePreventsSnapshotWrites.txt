@Test public void cleanupTrimFailurePreventsSnapshotWrites() throws Exception {
  cache.setMaxSize(8);
  executor.jobs.pop();
  set("a","aa","aa");
  set("b","bb","bbb");
  fileSystem.setFaultyDelete(new File(cacheDir,"a.0"),true);
  executor.jobs.pop().run();
  DiskLruCache.Snapshot snapshot1=cache.get("a");
  assertNull(snapshot1.edit());
  snapshot1.close();
  DiskLruCache.Snapshot snapshot2=cache.get("b");
  assertNull(snapshot2.edit());
  snapshot2.close();
  fileSystem.setFaultyDelete(new File(cacheDir,"a.0"),false);
}
