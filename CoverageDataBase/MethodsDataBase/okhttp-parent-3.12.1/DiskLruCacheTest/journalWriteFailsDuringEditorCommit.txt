/** 
 * We had a bug where the cache was left in an inconsistent state after a journal write failed. https://github.com/square/okhttp/issues/1211
 */
@Test public void journalWriteFailsDuringEditorCommit() throws Exception {
  set("a","a","a");
  set("b","b","b");
  DiskLruCache.Editor editor=cache.edit("c");
  setString(editor,0,"c");
  setString(editor,1,"c");
  fileSystem.setFaultyWrite(journalFile,true);
  editor.commit();
  fileSystem.setFaultyWrite(journalFile,false);
  assertNull(cache.edit("d"));
  cache.close();
  cache=new DiskLruCache(fileSystem,cacheDir,appVersion,2,Integer.MAX_VALUE,executor);
  assertValue("a","a","a");
  assertValue("b","b","b");
  assertAbsent("c");
  assertAbsent("d");
}
