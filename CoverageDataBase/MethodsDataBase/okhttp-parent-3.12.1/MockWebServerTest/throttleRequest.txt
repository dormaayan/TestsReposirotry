/** 
 * Throttle the request body by sleeping 500ms after every 3 bytes. With a 6-byte request, this should yield one sleep for a total delay of 500ms.
 */
@Test public void throttleRequest() throws Exception {
  server.enqueue(new MockResponse().throttleBody(3,500,TimeUnit.MILLISECONDS));
  long startNanos=System.nanoTime();
  URLConnection connection=server.url("/").url().openConnection();
  connection.setDoOutput(true);
  connection.getOutputStream().write("ABCDEF".getBytes("UTF-8"));
  InputStream in=connection.getInputStream();
  assertEquals(-1,in.read());
  long elapsedNanos=System.nanoTime() - startNanos;
  long elapsedMillis=NANOSECONDS.toMillis(elapsedNanos);
  assertTrue(Util.format("Request + Response: %sms",elapsedMillis),elapsedMillis >= 500);
  assertTrue(Util.format("Request + Response: %sms",elapsedMillis),elapsedMillis < 1000);
}
