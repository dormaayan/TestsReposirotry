@Test public void disconnectRequestHalfway() throws Exception {
  server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.DISCONNECT_DURING_REQUEST_BODY));
  server.setBodyLimit(7 * 512 * 1024);
  HttpURLConnection connection=(HttpURLConnection)server.url("/").url().openConnection();
  connection.setRequestMethod("POST");
  connection.setDoOutput(true);
  connection.setFixedLengthStreamingMode(1024 * 1024 * 1024);
  connection.connect();
  OutputStream out=connection.getOutputStream();
  byte[] data=new byte[1024 * 1024];
  int i;
  for (i=0; i < 1024; i++) {
    try {
      out.write(data);
      out.flush();
      if (i == 513) {
        Thread.sleep(100);
      }
    }
 catch (    IOException e) {
      break;
    }
  }
  assertEquals(512f,i,5f);
}
