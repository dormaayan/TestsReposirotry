/** 
 * Throttle the response body by sleeping 500ms after every 3 bytes. With a 6-byte response, this should yield one sleep for a total delay of 500ms.
 */
@Test public void throttleResponse() throws Exception {
  server.enqueue(new MockResponse().setBody("ABCDEF").throttleBody(3,500,TimeUnit.MILLISECONDS));
  long startNanos=System.nanoTime();
  URLConnection connection=server.url("/").url().openConnection();
  InputStream in=connection.getInputStream();
  assertEquals('A',in.read());
  assertEquals('B',in.read());
  assertEquals('C',in.read());
  assertEquals('D',in.read());
  assertEquals('E',in.read());
  assertEquals('F',in.read());
  assertEquals(-1,in.read());
  long elapsedNanos=System.nanoTime() - startNanos;
  long elapsedMillis=NANOSECONDS.toMillis(elapsedNanos);
  assertTrue(Util.format("Request + Response: %sms",elapsedMillis),elapsedMillis >= 500);
  assertTrue(Util.format("Request + Response: %sms",elapsedMillis),elapsedMillis < 1000);
}
