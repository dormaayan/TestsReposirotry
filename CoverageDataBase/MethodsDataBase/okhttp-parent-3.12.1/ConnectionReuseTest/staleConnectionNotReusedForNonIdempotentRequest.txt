@Test public void staleConnectionNotReusedForNonIdempotentRequest() throws Exception {
  server.enqueue(new MockResponse().setBody("a").setSocketPolicy(SocketPolicy.SHUTDOWN_OUTPUT_AT_END));
  server.enqueue(new MockResponse().setBody("b"));
  Request requestA=new Request.Builder().url(server.url("/")).build();
  Response responseA=client.newCall(requestA).execute();
  assertEquals("a",responseA.body().string());
  assertEquals(0,server.takeRequest().getSequenceNumber());
  Thread.sleep(250);
  Request requestB=new Request.Builder().url(server.url("/")).post(RequestBody.create(MediaType.get("text/plain"),"b")).build();
  Response responseB=client.newCall(requestB).execute();
  assertEquals("b",responseB.body().string());
  assertEquals(0,server.takeRequest().getSequenceNumber());
}
