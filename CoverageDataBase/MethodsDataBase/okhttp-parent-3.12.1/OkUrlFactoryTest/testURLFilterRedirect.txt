@Test public void testURLFilterRedirect(){
  MockWebServer cleartextServer=new MockWebServer();
  cleartextServer.enqueue(new MockResponse().setBody("Blocked!"));
  final URL blockedURL=cleartextServer.url("/").url();
  HandshakeCertificates handshakeCertificates=localhost();
  server.useHttps(handshakeCertificates.sslSocketFactory(),false);
  factory.setClient(factory.client().newBuilder().sslSocketFactory(handshakeCertificates.sslSocketFactory(),handshakeCertificates.trustManager()).followSslRedirects(true).build());
  factory.setUrlFilter(new URLFilter(){
    @Override public void checkURLPermitted(    URL url) throws IOException {
      if (blockedURL.equals(url)) {
        throw new IOException("Blocked");
      }
    }
  }
);
  server.enqueue(new MockResponse().setResponseCode(302).addHeader("Location: " + blockedURL).setBody("This page has moved"));
  URL destination=server.url("/").url();
  try {
    HttpsURLConnection httpsConnection=(HttpsURLConnection)factory.open(destination);
    httpsConnection.getInputStream();
    fail("Connection was successful");
  }
 catch (  IOException expected) {
  }
}
