/** 
 * https://code.google.com/p/android/issues/detail?id=74026 
 */
@Test public void authenticateWithGetAndTransparentGzip() throws Exception {
  MockResponse pleaseAuthenticate=new MockResponse().setResponseCode(401).addHeader("WWW-Authenticate: Basic realm=\"protected area\"").setBody("Please authenticate.");
  server.enqueue(pleaseAuthenticate);
  server.enqueue(pleaseAuthenticate);
  server.enqueue(pleaseAuthenticate);
  MockResponse successfulResponse=new MockResponse().addHeader("Content-Encoding","gzip").setBody(gzip("Successful auth!"));
  server.enqueue(successfulResponse);
  Authenticator.setDefault(new RecordingAuthenticator());
  urlFactory.setClient(urlFactory.client().newBuilder().authenticator(new JavaNetAuthenticator()).build());
  connection=urlFactory.open(server.url("/").url());
  assertEquals("Successful auth!",readAscii(connection.getInputStream(),Integer.MAX_VALUE));
  RecordedRequest request=server.takeRequest();
  assertNull(request.getHeader("Authorization"));
  for (int i=0; i < 3; i++) {
    request=server.takeRequest();
    assertEquals("GET / HTTP/1.1",request.getRequestLine());
    assertEquals("Basic " + RecordingAuthenticator.BASE_64_CREDENTIALS,request.getHeader("Authorization"));
  }
}
