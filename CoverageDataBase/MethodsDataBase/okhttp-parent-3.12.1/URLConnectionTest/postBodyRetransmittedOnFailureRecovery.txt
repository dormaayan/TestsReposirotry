@Test public void postBodyRetransmittedOnFailureRecovery() throws Exception {
  server.enqueue(new MockResponse().setBody("abc"));
  server.enqueue(new MockResponse().setSocketPolicy(DISCONNECT_AFTER_REQUEST));
  server.enqueue(new MockResponse().setBody("def"));
  assertContent("abc",urlFactory.open(server.url("/").url()));
  HttpURLConnection post=urlFactory.open(server.url("/").url());
  post.setDoOutput(true);
  post.getOutputStream().write("body!".getBytes(UTF_8));
  assertContent("def",post);
  RecordedRequest get=server.takeRequest();
  assertEquals(0,get.getSequenceNumber());
  RecordedRequest post1=server.takeRequest();
  assertEquals("body!",post1.getBody().readUtf8());
  assertEquals(1,post1.getSequenceNumber());
  RecordedRequest post2=server.takeRequest();
  assertEquals("body!",post2.getBody().readUtf8());
  assertEquals(0,post2.getSequenceNumber());
}
