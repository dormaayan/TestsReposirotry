@Test public void inspectHandshakeThroughoutRequestLifecycle() throws Exception {
  server.useHttps(handshakeCertificates.sslSocketFactory(),false);
  server.enqueue(new MockResponse());
  urlFactory.setClient(urlFactory.client().newBuilder().sslSocketFactory(handshakeCertificates.sslSocketFactory(),handshakeCertificates.trustManager()).hostnameVerifier(new RecordingHostnameVerifier()).build());
  HttpsURLConnection httpsConnection=(HttpsURLConnection)urlFactory.open(server.url("/foo").url());
  try {
    httpsConnection.getCipherSuite();
    fail();
  }
 catch (  IllegalStateException expected) {
  }
  httpsConnection.connect();
  assertNotNull(httpsConnection.getCipherSuite());
  assertContent("",httpsConnection);
  assertNotNull(httpsConnection.getCipherSuite());
  httpsConnection.disconnect();
  assertNotNull(httpsConnection.getCipherSuite());
}
