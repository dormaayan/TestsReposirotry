/** 
 * Tolerate bad https proxy response when using HttpResponseCache. Android bug 6754912. 
 */
@Test public void connectViaHttpProxyToHttpsUsingBadProxyAndHttpResponseCache() throws Exception {
  initResponseCache();
  server.useHttps(handshakeCertificates.sslSocketFactory(),true);
  MockResponse badProxyResponse=new MockResponse().setSocketPolicy(UPGRADE_TO_SSL_AT_END).setBody("bogus proxy connect response content");
  server.enqueue(badProxyResponse);
  server.enqueue(new MockResponse().setBody("response"));
  urlFactory.setClient(urlFactory.client().newBuilder().sslSocketFactory(handshakeCertificates.sslSocketFactory(),handshakeCertificates.trustManager()).connectionSpecs(Util.immutableList(ConnectionSpec.MODERN_TLS)).hostnameVerifier(new RecordingHostnameVerifier()).proxy(server.toProxyAddress()).build());
  URL url=new URL("https://android.com/foo");
  connection=urlFactory.open(url);
  assertContent("response",connection);
  RecordedRequest connect=server.takeRequest();
  assertEquals("CONNECT android.com:443 HTTP/1.1",connect.getRequestLine());
  assertEquals("android.com:443",connect.getHeader("Host"));
}
