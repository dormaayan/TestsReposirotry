@Test public void successfulHttpProxyConnect() throws IOException {
  server.enqueue(new MockResponse());
  client=client.newBuilder().proxy(server.toProxyAddress()).build();
  Call call=client.newCall(new Request.Builder().url("http://www.fakeurl").build());
  Response response=call.execute();
  assertEquals(200,response.code());
  response.body().close();
  InetAddress address=client.dns().lookup(server.getHostName()).get(0);
  InetSocketAddress expectedAddress=new InetSocketAddress(address,server.getPort());
  ConnectStart connectStart=listener.removeUpToEvent(ConnectStart.class);
  assertSame(call,connectStart.call);
  assertEquals(expectedAddress,connectStart.inetSocketAddress);
  assertEquals(server.toProxyAddress(),connectStart.proxy);
  ConnectEnd connectEnd=listener.removeUpToEvent(ConnectEnd.class);
  assertSame(call,connectEnd.call);
  assertEquals(expectedAddress,connectEnd.inetSocketAddress);
  assertEquals(Protocol.HTTP_1_1,connectEnd.protocol);
}
