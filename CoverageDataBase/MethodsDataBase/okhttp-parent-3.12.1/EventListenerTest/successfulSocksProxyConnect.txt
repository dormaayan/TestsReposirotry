@Test public void successfulSocksProxyConnect() throws Exception {
  server.enqueue(new MockResponse());
  socksProxy=new SocksProxy();
  socksProxy.play();
  Proxy proxy=socksProxy.proxy();
  client=client.newBuilder().proxy(proxy).build();
  Call call=client.newCall(new Request.Builder().url("http://" + SocksProxy.HOSTNAME_THAT_ONLY_THE_PROXY_KNOWS + ":"+ server.getPort()).build());
  Response response=call.execute();
  assertEquals(200,response.code());
  response.body().close();
  InetSocketAddress expectedAddress=InetSocketAddress.createUnresolved(SocksProxy.HOSTNAME_THAT_ONLY_THE_PROXY_KNOWS,server.getPort());
  ConnectStart connectStart=listener.removeUpToEvent(ConnectStart.class);
  assertSame(call,connectStart.call);
  assertEquals(expectedAddress,connectStart.inetSocketAddress);
  assertEquals(proxy,connectStart.proxy);
  ConnectEnd connectEnd=listener.removeUpToEvent(ConnectEnd.class);
  assertSame(call,connectEnd.call);
  assertEquals(expectedAddress,connectEnd.inetSocketAddress);
  assertEquals(Protocol.HTTP_1_1,connectEnd.protocol);
}
