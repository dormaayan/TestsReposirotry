@Test public void conditionalHitUpdatesCache() throws Exception {
  server.enqueue(new MockResponse().addHeader("Last-Modified: " + formatDate(0,TimeUnit.SECONDS)).addHeader("Cache-Control: max-age=0").setBody("A"));
  server.enqueue(new MockResponse().addHeader("Cache-Control: max-age=30").addHeader("Allow: GET, HEAD").setResponseCode(HttpURLConnection.HTTP_NOT_MODIFIED));
  server.enqueue(new MockResponse().setBody("B"));
  long t0=System.currentTimeMillis();
  Response response1=get(server.url("/a"));
  assertEquals("A",response1.body().string());
  assertEquals(null,response1.header("Allow"));
  assertEquals(0,response1.receivedResponseAtMillis() - t0,250.0);
  Thread.sleep(500);
  long t1=System.currentTimeMillis();
  Response response2=get(server.url("/a"));
  assertEquals(HttpURLConnection.HTTP_OK,response2.code());
  assertEquals("A",response2.body().string());
  assertEquals("GET, HEAD",response2.header("Allow"));
  assertEquals(0,response2.receivedResponseAtMillis() - t1,250.0);
  Thread.sleep(500);
  long t2=System.currentTimeMillis();
  Response response3=get(server.url("/a"));
  assertEquals("A",response3.body().string());
  assertEquals("GET, HEAD",response3.header("Allow"));
  assertEquals(0,response3.receivedResponseAtMillis() - t1,250.0);
  assertEquals(2,server.getRequestCount());
}
