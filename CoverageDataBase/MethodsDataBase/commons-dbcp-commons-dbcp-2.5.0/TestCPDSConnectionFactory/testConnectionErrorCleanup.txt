/** 
 * JIRA DBCP-216 Verify that pool counters are maintained properly and listeners are cleaned up when a PooledConnection throws a connectionError event.
 */
@Test public void testConnectionErrorCleanup() throws Exception {
  final CPDSConnectionFactory factory=new CPDSConnectionFactory(cpds,null,-1,false,"userName","password");
  final GenericObjectPool<PooledConnectionAndInfo> pool=new GenericObjectPool<>(factory);
  factory.setPool(pool);
  final PooledConnection pcon1=pool.borrowObject().getPooledConnection();
  final Connection con1=pcon1.getConnection();
  final PooledConnection pcon2=pool.borrowObject().getPooledConnection();
  assertEquals(2,pool.getNumActive());
  assertEquals(0,pool.getNumIdle());
  final PooledConnectionProxy pc=(PooledConnectionProxy)pcon1;
  assertTrue(pc.getListeners().contains(factory));
  pc.throwConnectionError();
  assertEquals(1,pool.getNumActive());
  assertEquals(0,pool.getNumIdle());
  pc.throwConnectionError();
  assertEquals(1,pool.getNumActive());
  assertEquals(0,pool.getNumIdle());
  final PooledConnection pcon3=pool.borrowObject().getPooledConnection();
  assertTrue(!pcon3.equals(pcon1));
  assertTrue(!pc.getListeners().contains(factory));
  assertEquals(2,pool.getNumActive());
  assertEquals(0,pool.getNumIdle());
  pcon2.getConnection().close();
  pcon3.getConnection().close();
  assertEquals(2,pool.getNumIdle());
  assertEquals(0,pool.getNumActive());
  try {
    pc.getConnection();
    fail("Expecting SQLException using closed PooledConnection");
  }
 catch (  final SQLException ex) {
  }
  con1.close();
  assertEquals(2,pool.getNumIdle());
  assertEquals(0,pool.getNumActive());
  factory.getPool().clear();
  assertEquals(0,pool.getNumIdle());
}
