/** 
 * JIRA DBCP-216 Check PoolableConnection close triggered by destroy is handled properly. PooledConnectionProxy (dubiously) fires connectionClosed when PooledConnection itself is closed.
 */
@Test public void testSharedPoolDSDestroyOnReturn() throws Exception {
  final PerUserPoolDataSource ds=new PerUserPoolDataSource();
  ds.setConnectionPoolDataSource(cpds);
  ds.setPerUserMaxTotal("userName",Integer.valueOf(10));
  ds.setPerUserMaxWaitMillis("userName",Long.valueOf(50));
  ds.setPerUserMaxIdle("userName",Integer.valueOf(2));
  final Connection conn1=ds.getConnection("userName","password");
  final Connection conn2=ds.getConnection("userName","password");
  final Connection conn3=ds.getConnection("userName","password");
  assertEquals(3,ds.getNumActive("userName"));
  conn1.close();
  assertEquals(1,ds.getNumIdle("userName"));
  conn2.close();
  assertEquals(2,ds.getNumIdle("userName"));
  conn3.close();
  assertEquals(2,ds.getNumIdle("userName"));
  ds.close();
}
