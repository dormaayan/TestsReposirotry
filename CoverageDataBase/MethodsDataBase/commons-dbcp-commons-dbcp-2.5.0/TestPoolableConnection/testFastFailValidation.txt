@Test public void testFastFailValidation() throws Exception {
  pool.setTestOnReturn(true);
  final PoolableConnectionFactory factory=(PoolableConnectionFactory)pool.getFactory();
  factory.setFastFailValidation(true);
  final PoolableConnection conn=pool.borrowObject();
  final TesterConnection nativeConnection=(TesterConnection)conn.getInnermostDelegate();
  nativeConnection.setFailure(new SQLException("Not fatal error.","Invalid syntax."));
  try {
    conn.createStatement();
    fail("Should throw SQL exception.");
  }
 catch (  final SQLException ignored) {
    nativeConnection.setFailure(null);
  }
  conn.validate("SELECT 1",1000);
  nativeConnection.setFailure(new SQLException("Fatal connection error.","01002"));
  try {
    conn.createStatement();
    fail("Should throw SQL exception.");
  }
 catch (  final SQLException ignored) {
    nativeConnection.setFailure(null);
  }
  try {
    conn.validate("SELECT 1",1000);
    fail("Should throw SQL exception on validation.");
  }
 catch (  final SQLException notValid) {
  }
  conn.close();
  assertEquals("The pool should have no active connections",0,pool.getNumActive());
  assertEquals("The pool should have no idle connections",0,pool.getNumIdle());
}
