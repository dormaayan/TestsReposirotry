/** 
 * JIRA: DBCP-294 Verify that PoolableConnections created by BasicManagedDataSource unregister themselves when reallyClosed.
 */
@Test public void testReallyClose() throws Exception {
  final BasicManagedDataSource basicManagedDataSource=new BasicManagedDataSource();
  basicManagedDataSource.setTransactionManager(new TransactionManagerImpl());
  basicManagedDataSource.setDriverClassName("org.apache.commons.dbcp2.TesterDriver");
  basicManagedDataSource.setUrl("jdbc:apache:commons:testdriver");
  basicManagedDataSource.setUsername("userName");
  basicManagedDataSource.setPassword("password");
  basicManagedDataSource.setMaxIdle(1);
  final ManagedConnection<?> conn=(ManagedConnection<?>)basicManagedDataSource.getConnection();
  assertNotNull(basicManagedDataSource.getTransactionRegistry().getXAResource(conn));
  final ManagedConnection<?> conn2=(ManagedConnection<?>)basicManagedDataSource.getConnection();
  conn2.close();
  conn.close();
  try {
    basicManagedDataSource.getTransactionRegistry().getXAResource(conn);
    fail("Expecting SQLException - XAResources orphaned");
  }
 catch (  final SQLException ex) {
  }
  conn2.close();
  basicManagedDataSource.close();
}
