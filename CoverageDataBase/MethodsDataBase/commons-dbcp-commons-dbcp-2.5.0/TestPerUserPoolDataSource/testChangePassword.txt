@Test public void testChangePassword() throws Exception {
  try (Connection c=ds.getConnection(user,"bay")){
    fail("Should have generated SQLException");
  }
 catch (  final SQLException expected) {
  }
  final Connection con1=ds.getConnection(user,"bar");
  final Connection con2=ds.getConnection(user,"bar");
  final Connection con3=ds.getConnection(user,"bar");
  con1.close();
  con2.close();
  TesterDriver.addUser(user,"bay");
  try {
    final Connection con4=ds.getConnection(user,"bay");
    assertEquals("Should be no idle connections in the pool",0,((PerUserPoolDataSource)ds).getNumIdle(user));
    con4.close();
    assertEquals("Should be one idle connection in the pool",1,((PerUserPoolDataSource)ds).getNumIdle(user));
    try (Connection c=ds.getConnection(user,"bar")){
      fail("Should have generated SQLException");
    }
 catch (    final SQLException expected) {
    }
    final Connection con5=ds.getConnection(user,"bay");
    con3.close();
    ds.getConnection(user,"bay").close();
    assertEquals("Should be one idle connection in the pool",1,((PerUserPoolDataSource)ds).getNumIdle(user));
    con5.close();
  }
  finally {
    TesterDriver.addUser(user,"bar");
  }
}
