@Test public void separateClassLoader() throws Exception {
  ClassLoader contextLoader=Thread.currentThread().getContextClassLoader();
  ClassLoader systemLoader=ClassLoader.getSystemClassLoader();
  ClassLoader loader=MoreObjects.firstNonNull(contextLoader,systemLoader);
  if (loader instanceof URLClassLoader) {
    URLClassLoader urlLoader=(URLClassLoader)loader;
    ClassLoader separateLoader=new URLClassLoader(urlLoader.getURLs(),systemLoader.getParent());
    Thread.currentThread().setContextClassLoader(separateLoader);
    try {
      Class<?> thisClass=separateLoader.loadClass(getClass().getName());
      Method createFileSystem=thisClass.getDeclaredMethod("createFileSystem");
      Object fs=createFileSystem.invoke(null);
      assertEquals("com.google.common.jimfs.JimfsFileSystem",fs.getClass().getName());
      assertFalse(fs instanceof JimfsFileSystem);
      assertTrue(fs instanceof FileSystem);
      writeAndRead((FileSystem)fs,"bar.txt","blah blah");
      assertEquals("blah",Files.readAllLines(((FileSystem)fs).getPath("foo.txt"),UTF_8).get(0));
    }
  finally {
      Thread.currentThread().setContextClassLoader(contextLoader);
    }
  }
}
