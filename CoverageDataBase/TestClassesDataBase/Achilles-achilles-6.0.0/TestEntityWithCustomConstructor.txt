public class TestEntityWithCustomConstructor {
  @Rule public AchillesTestResource<ManagerFactory> resource=AchillesTestResourceBuilder.forJunit().entityClassesToTruncate(EntityWithCustomConstructor.class).truncateBeforeAndAfterTest().withScript("create_keyspace.cql").build((cluster,statementsCache) -> ManagerFactoryBuilder.builder(cluster).withManagedEntityClasses(EntityWithCustomConstructor.class).doForceSchemaCreation(true).withStatementsCache(statementsCache).withDefaultKeyspaceName(DEFAULT_CASSANDRA_EMBEDDED_KEYSPACE_NAME).build());
  private Session session=resource.getNativeSession();
  private ScriptExecutor scriptExecutor=resource.getScriptExecutor();
  private EntityWithCustomConstructor_Manager manager=resource.getManagerFactory().forEntityWithCustomConstructor();
  @Test public void should_find_by_id() throws Exception {
    final long id=RandomUtils.nextLong(0L,Long.MAX_VALUE);
    scriptExecutor.executeScriptTemplate("EntityWithCustomConstructor/should_insert_row.cql",ImmutableMap.of("id",id));
    final EntityWithCustomConstructor actual=manager.crud().findById(id).get();
    assertThat(actual).isNotNull();
    assertThat(actual.getName()).isEqualTo("name");
    assertThat(actual.getValue()).isEqualTo(2.0);
    assertThat(actual.getUdt()).isNotNull();
    assertThat(actual.getUdt().getIdx()).isEqualTo(3L);
    assertThat(actual.getUdt().getValue()).isEqualTo("value_udt");
  }
  @Test public void should_dsl_select_one() throws Exception {
    final long id=RandomUtils.nextLong(0L,Long.MAX_VALUE);
    scriptExecutor.executeScriptTemplate("EntityWithCustomConstructor/should_insert_row.cql",ImmutableMap.of("id",id));
    final EntityWithCustomConstructor actual=manager.dsl().select().allColumns_FromBaseTable().where().id().Eq(id).getOne();
    assertThat(actual).isNotNull();
    assertThat(actual.getName()).isEqualTo("name");
    assertThat(actual.getValue()).isEqualTo(2.0);
    assertThat(actual.getUdt()).isNotNull();
    assertThat(actual.getUdt().getIdx()).isEqualTo(3L);
    assertThat(actual.getUdt().getValue()).isEqualTo("value_udt");
  }
  @Test public void should_typed_query() throws Exception {
    final long id=RandomUtils.nextLong(0L,Long.MAX_VALUE);
    scriptExecutor.executeScriptTemplate("EntityWithCustomConstructor/should_insert_row.cql",ImmutableMap.of("id",id));
    final SimpleStatement statement=new SimpleStatement("SELECT id,value,udt FROM achilles_embedded.entity_custom_constructor WHERE id=?");
    final PreparedStatement ps=session.prepare(statement);
    final EntityWithCustomConstructor actual=manager.raw().typedQueryForSelect(ps.bind(id)).getOne();
    assertThat(actual).isNotNull();
    assertThat(actual.getName()).isNull();
    assertThat(actual.getValue()).isEqualTo(2.0);
    assertThat(actual.getUdt()).isNotNull();
    assertThat(actual.getUdt().getIdx()).isEqualTo(3L);
    assertThat(actual.getUdt().getValue()).isEqualTo("value_udt");
  }
}
