public class TestImmutableEntity {
  @Rule public AchillesTestResource<ManagerFactory> resource=AchillesTestResourceBuilder.forJunit().entityClassesToTruncate(ImmutableEntity.class).truncateBeforeAndAfterTest().withScript("create_keyspace.cql").build((cluster,statementsCache) -> ManagerFactoryBuilder.builder(cluster).withManagedEntityClasses(ImmutableEntity.class).doForceSchemaCreation(true).withStatementsCache(statementsCache).withDefaultKeyspaceName(DEFAULT_CASSANDRA_EMBEDDED_KEYSPACE_NAME).build());
  private Session session=resource.getNativeSession();
  private ScriptExecutor scriptExecutor=resource.getScriptExecutor();
  private ImmutableEntity_Manager manager=resource.getManagerFactory().forImmutableEntity();
  @Test public void should_find_by_id() throws Exception {
    final long id=RandomUtils.nextLong(0L,Long.MAX_VALUE);
    scriptExecutor.executeScriptTemplate("ImmutableEntity/should_insert_row.cql",ImmutableMap.of("id",id));
    final ImmutableEntity actual=manager.crud().findById(id).get();
    assertThat(actual).isNotNull();
    assertThat(actual.name).isEqualTo("name");
    assertThat(actual.value).isEqualTo(2.0);
    assertThat(actual.udt).isNotNull();
    assertThat(actual.udt.idx).isEqualTo(3L);
    assertThat(actual.udt.value).isEqualTo("value_udt");
  }
  @Test public void should_dsl_select_one() throws Exception {
    final long id=RandomUtils.nextLong(0L,Long.MAX_VALUE);
    scriptExecutor.executeScriptTemplate("ImmutableEntity/should_insert_row.cql",ImmutableMap.of("id",id));
    final ImmutableEntity actual=manager.dsl().select().allColumns_FromBaseTable().where().id().Eq(id).getOne();
    assertThat(actual).isNotNull();
    assertThat(actual.name).isEqualTo("name");
    assertThat(actual.value).isEqualTo(2.0);
    assertThat(actual.udt).isNotNull();
    assertThat(actual.udt.idx).isEqualTo(3L);
    assertThat(actual.udt.value).isEqualTo("value_udt");
  }
  @Test public void should_typed_query() throws Exception {
    final long id=RandomUtils.nextLong(0L,Long.MAX_VALUE);
    scriptExecutor.executeScriptTemplate("ImmutableEntity/should_insert_row.cql",ImmutableMap.of("id",id));
    final SimpleStatement statement=new SimpleStatement("SELECT id,value,udt FROM achilles_embedded.immutable_entity WHERE id=?");
    final PreparedStatement ps=session.prepare(statement);
    final ImmutableEntity actual=manager.raw().typedQueryForSelect(ps.bind(id)).getOne();
    assertThat(actual).isNotNull();
    assertThat(actual.name).isNull();
    assertThat(actual.value).isEqualTo(2.0);
    assertThat(actual.udt).isNotNull();
    assertThat(actual.udt.idx).isEqualTo(3L);
    assertThat(actual.udt.value).isEqualTo("value_udt");
  }
}
