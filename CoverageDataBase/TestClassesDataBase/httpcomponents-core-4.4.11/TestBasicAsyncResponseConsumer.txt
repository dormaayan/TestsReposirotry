public class TestBasicAsyncResponseConsumer {
  private BasicAsyncResponseConsumer consumer;
  @Mock private HttpResponse response;
  @Mock private HttpContext context;
  @Mock private ContentDecoder decoder;
  @Mock private IOControl ioControl;
  @Before public void setUp() throws Exception {
    MockitoAnnotations.initMocks(this);
    consumer=Mockito.spy(new BasicAsyncResponseConsumer());
  }
  @After public void tearDown() throws Exception {
  }
  @Test public void testResponseProcessing() throws Exception {
    when(response.getEntity()).thenReturn(new StringEntity("stuff"));
    consumer.responseReceived(response);
    consumer.consumeContent(decoder,ioControl);
    consumer.responseCompleted(context);
    verify(consumer).releaseResources();
    verify(consumer).buildResult(context);
    Assert.assertTrue(consumer.isDone());
    Assert.assertSame(response,consumer.getResult());
    consumer.responseCompleted(context);
    verify(consumer,times(1)).releaseResources();
    verify(consumer,times(1)).buildResult(context);
  }
  @Test public void testResponseProcessingWithException() throws Exception {
    when(response.getEntity()).thenReturn(new StringEntity("stuff"));
    final RuntimeException ooopsie=new RuntimeException();
    when(consumer.buildResult(context)).thenThrow(ooopsie);
    consumer.responseReceived(response);
    consumer.consumeContent(decoder,ioControl);
    consumer.responseCompleted(context);
    verify(consumer).releaseResources();
    Assert.assertTrue(consumer.isDone());
    Assert.assertSame(ooopsie,consumer.getException());
  }
  @Test public void testCancel() throws Exception {
    Assert.assertTrue(consumer.cancel());
    verify(consumer).releaseResources();
    Assert.assertTrue(consumer.isDone());
    Assert.assertFalse(consumer.cancel());
    verify(consumer,times(1)).releaseResources();
  }
  @Test public void testFailed() throws Exception {
    final RuntimeException ooopsie=new RuntimeException();
    consumer.failed(ooopsie);
    verify(consumer).releaseResources();
    Assert.assertTrue(consumer.isDone());
    Assert.assertSame(ooopsie,consumer.getException());
  }
  @Test public void testFailedAfterDone() throws Exception {
    final RuntimeException ooopsie=new RuntimeException();
    consumer.cancel();
    consumer.failed(ooopsie);
    verify(consumer,times(1)).releaseResources();
    Assert.assertTrue(consumer.isDone());
    Assert.assertNull(consumer.getException());
  }
  @Test public void testClose() throws Exception {
    consumer.close();
    verify(consumer).releaseResources();
    Assert.assertTrue(consumer.isDone());
    consumer.close();
    verify(consumer,times(1)).releaseResources();
  }
}
