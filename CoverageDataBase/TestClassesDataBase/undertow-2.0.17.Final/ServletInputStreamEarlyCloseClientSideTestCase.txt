/** 
 * Tests the behaviour of the input stream when the connection is closed on the client side <p/> https://issues.jboss.org/browse/WFLY-4827
 * @author Stuart Douglas
 */
@RunWith(DefaultServer.class) @HttpOneOnly public class ServletInputStreamEarlyCloseClientSideTestCase {
  public static final String SERVLET="servlet";
  @BeforeClass public static void setup() throws ServletException {
    DeploymentUtils.setupServlet(new ServletInfo(SERVLET,EarlyCloseClientServlet.class).addMapping("/" + SERVLET));
  }
  @Test public void testServletInputStreamEarlyClose() throws Exception {
    Assume.assumeFalse(DefaultServer.isH2());
    TestHttpClient client=new TestHttpClient();
    EarlyCloseClientServlet.reset();
    try (Socket socket=new Socket()){
      socket.connect(DefaultServer.getDefaultServerAddress());
      try {
        StringBuilder sb=new StringBuilder();
        for (int i=0; i < 10000; ++i) {
          sb.append("hello world\r\n");
        }
        String request="POST /servletContext/" + SERVLET + " HTTP/1.1\r\nHost:localhost\r\nContent-Length:"+ sb.length()+ 100+ "\r\n\r\n"+ sb.toString();
        OutputStream outputStream=socket.getOutputStream();
        outputStream.write(request.getBytes("US-ASCII"));
        outputStream.flush();
        socket.close();
        Assert.assertTrue(EarlyCloseClientServlet.getLatch().await(10,TimeUnit.SECONDS));
        Assert.assertFalse(EarlyCloseClientServlet.isCompletedNormally());
        Assert.assertTrue(EarlyCloseClientServlet.isExceptionThrown());
      }
  finally {
        client.getConnectionManager().shutdown();
      }
    }
   }
}
