/** 
 * Tests that head requests will never send a response body, even if a handler author has not considered HEAD methods when implementing the handler.
 * @author Stuart Douglas
 */
@RunWith(DefaultServer.class) public class HeadTestCase {
  private static final String MESSAGE="My HTTP Request!";
  private static volatile String message;
  private static volatile ServerConnection connection;
  @BeforeClass public static void setup(){
    DefaultServer.setRootHandler(new HttpHandler(){
      @Override public void handleRequest(      final HttpServerExchange exchange) throws Exception {
        if (connection == null) {
          connection=exchange.getConnection();
        }
 else         if (!DefaultServer.isAjp() && !DefaultServer.isProxy() && connection != exchange.getConnection()) {
          Sender sender=exchange.getResponseSender();
          sender.send("Connection not persistent");
          return;
        }
        exchange.getResponseHeaders().put(Headers.CONTENT_LENGTH,message.length() + "");
        final Sender sender=exchange.getResponseSender();
        sender.send(message);
      }
    }
);
  }
  @Test public void sendHttpHead() throws IOException {
    connection=null;
    HttpGet get=new HttpGet(DefaultServer.getDefaultServerURL() + "/path");
    HttpHead head=new HttpHead(DefaultServer.getDefaultServerURL() + "/path");
    TestHttpClient client=new TestHttpClient();
    try {
      generateMessage(1);
      HttpResponse result=client.execute(get);
      Assert.assertEquals(StatusCodes.OK,result.getStatusLine().getStatusCode());
      Assert.assertEquals(message,HttpClientUtils.readResponse(result));
      result=client.execute(head);
      Assert.assertEquals(StatusCodes.OK,result.getStatusLine().getStatusCode());
      Assert.assertEquals("",HttpClientUtils.readResponse(result));
      generateMessage(1000);
      result=client.execute(get);
      Assert.assertEquals(StatusCodes.OK,result.getStatusLine().getStatusCode());
      Assert.assertEquals(message,HttpClientUtils.readResponse(result));
      result=client.execute(head);
      Assert.assertEquals(StatusCodes.OK,result.getStatusLine().getStatusCode());
      Assert.assertEquals("",HttpClientUtils.readResponse(result));
    }
  finally {
      client.getConnectionManager().shutdown();
    }
  }
  private static void generateMessage(  int repetitions){
    final StringBuilder builder=new StringBuilder(repetitions * MESSAGE.length());
    for (int i=0; i < repetitions; ++i) {
      builder.append(MESSAGE);
    }
    message=builder.toString();
  }
}
