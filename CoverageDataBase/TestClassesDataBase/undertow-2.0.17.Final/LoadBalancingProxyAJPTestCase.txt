/** 
 * Tests the load balancing proxy
 * @author Stuart Douglas
 */
@RunWith(DefaultServer.class) public class LoadBalancingProxyAJPTestCase extends AbstractLoadBalancingProxyTestCase {
  @BeforeClass public static void setup() throws URISyntaxException {
    int port=DefaultServer.getHostPort("default");
    server1=Undertow.builder().addAjpListener(port + 1,DefaultServer.getHostAddress("default")).setSocketOption(Options.REUSE_ADDRESSES,true).setServerOption(UndertowOptions.NO_REQUEST_TIMEOUT,IDLE_TIMEOUT).setHandler(getRootHandler("s1","server1")).build();
    server2=Undertow.builder().addAjpListener(port + 2,DefaultServer.getHostAddress("default")).setSocketOption(Options.REUSE_ADDRESSES,true).setServerOption(UndertowOptions.NO_REQUEST_TIMEOUT,IDLE_TIMEOUT).setHandler(getRootHandler("s2","server2")).build();
    server1.start();
    server2.start();
    DefaultServer.setRootHandler(ProxyHandler.builder().setProxyClient(new LoadBalancingProxyClient().setConnectionsPerThread(16).addHost(new URI("ajp",null,DefaultServer.getHostAddress("default"),port + 1,null,null,null),"s1").addHost(new URI("ajp",null,DefaultServer.getHostAddress("default"),port + 2,null,null,null),"s2")).setMaxRequestTime(10000).setMaxConnectionRetries(2).build());
  }
}
