@State(Scope.Thread) @BenchmarkMode(Mode.Throughput) @OutputTimeUnit(TimeUnit.SECONDS) public class AnagramBagTest extends AbstractJMHTestRunner {
  private static final int SIZE=1_000_000;
  private static final int BATCH_SIZE=10_000;
  private static final int SIZE_THRESHOLD=10;
  private final HashBag<String> gscWords=HashBag.newBag(FastList.newWithNValues(SIZE,() -> RandomStringUtils.randomAlphabetic(5).toUpperCase()));
  private final Multiset<String> guavaWords=HashMultiset.create(this.gscWords);
  private ExecutorService executorService;
  @Setup public void setUp(){
    this.executorService=Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());
  }
  @TearDown public void tearDown() throws InterruptedException {
    this.executorService.shutdownNow();
    this.executorService.awaitTermination(1L,TimeUnit.SECONDS);
  }
  @Benchmark public void serial_eager_gsc(){
    MutableListMultimap<Alphagram,String> groupBy=this.gscWords.groupBy(Alphagram::new,FastListMultimap.newMultimap());
    groupBy.multiValuesView().select(iterable -> iterable.size() >= SIZE_THRESHOLD).toSortedList(Comparators.<RichIterable<String>>byIntFunction(RichIterable::size)).asReversed().collect(iterable -> iterable.size() + ": " + iterable).forEach(Procedures.cast(e -> Assert.assertFalse(e.isEmpty())));
  }
  @Benchmark public void parallel_eager_gsc(){
    MutableMultimap<Alphagram,String> groupBy=ParallelIterate.groupBy(this.gscWords,Alphagram::new);
    groupBy.multiValuesView().select(iterable -> iterable.size() >= SIZE_THRESHOLD).toSortedList(Comparators.<RichIterable<String>>byIntFunction(RichIterable::size)).asReversed().collect(iterable -> iterable.size() + ": " + iterable).forEach(Procedures.cast(e -> Assert.assertFalse(e.isEmpty())));
  }
  @Benchmark public void parallel_lazy_gsc(){
    ParallelUnsortedBag<String> parallelUnsortedBag=this.gscWords.asParallel(this.executorService,BATCH_SIZE);
    UnsortedBagMultimap<Alphagram,String> groupBy=parallelUnsortedBag.groupBy(Alphagram::new);
    groupBy.multiValuesView().select(iterable -> iterable.size() >= SIZE_THRESHOLD).toSortedList(Comparators.<RichIterable<String>>byIntFunction(RichIterable::size)).asReversed().collect(iterable -> iterable.size() + ": " + iterable).forEach(Procedures.cast(e -> Assert.assertFalse(e.isEmpty())));
  }
  @Benchmark public void parallel_eager_forkjoin_gsc(){
    MutableMultimap<Alphagram,String> groupBy=FJIterate.groupBy(this.gscWords,Alphagram::new);
    groupBy.multiValuesView().select(iterable -> iterable.size() >= SIZE_THRESHOLD).toSortedList(Comparators.<RichIterable<String>>byIntFunction(RichIterable::size)).asReversed().collect(iterable -> iterable.size() + ": " + iterable).forEach(Procedures.cast(e -> Assert.assertFalse(e.isEmpty())));
  }
  @Benchmark public void serial_lazy_jdk(){
    Map<Alphagram,List<String>> groupBy=this.guavaWords.stream().collect(Collectors.groupingBy(Alphagram::new));
    groupBy.entrySet().stream().map(Map.Entry::getValue).filter(list -> list.size() >= SIZE_THRESHOLD).sorted(Comparator.<List<String>>comparingInt(List::size).reversed()).map(list -> list.size() + ": " + list).forEach(e -> Assert.assertFalse(e.isEmpty()));
  }
  @Benchmark public void serial_lazy_streams_gsc(){
    Map<Alphagram,List<String>> groupBy=this.gscWords.stream().collect(Collectors.groupingBy(Alphagram::new));
    groupBy.entrySet().stream().map(Map.Entry::getValue).filter(list -> list.size() >= SIZE_THRESHOLD).sorted(Comparator.<List<String>>comparingInt(List::size).reversed()).map(list -> list.size() + ": " + list).forEach(e -> Assert.assertFalse(e.isEmpty()));
  }
  @Benchmark public void parallel_lazy_jdk(){
    Map<Alphagram,List<String>> groupBy=this.guavaWords.parallelStream().collect(Collectors.groupingBy(Alphagram::new));
    groupBy.entrySet().parallelStream().map(Map.Entry::getValue).filter(list -> list.size() >= SIZE_THRESHOLD).sorted(Comparator.<List<String>>comparingInt(List::size).reversed()).map(list -> list.size() + ": " + list).forEach(e -> Assert.assertFalse(e.isEmpty()));
  }
  @Benchmark public void parallel_lazy_streams_gsc(){
    Map<Alphagram,List<String>> groupBy=this.gscWords.parallelStream().collect(Collectors.groupingBy(Alphagram::new));
    groupBy.entrySet().parallelStream().map(Map.Entry::getValue).filter(list -> list.size() >= SIZE_THRESHOLD).sorted(Comparator.<List<String>>comparingInt(List::size).reversed()).map(list -> list.size() + ": " + list).forEach(e -> Assert.assertFalse(e.isEmpty()));
  }
private static final class Alphagram {
    private final char[] key;
    private Alphagram(    String string){
      this.key=string.toCharArray();
      Arrays.sort(this.key);
    }
    @Override public boolean equals(    Object o){
      if (this == o) {
        return true;
      }
      if (o == null || this.getClass() != o.getClass()) {
        return false;
      }
      Alphagram alphagram=(Alphagram)o;
      return Arrays.equals(this.key,alphagram.key);
    }
    @Override public int hashCode(){
      return Arrays.hashCode(this.key);
    }
    @Override public String toString(){
      return new String(this.key);
    }
  }
}
