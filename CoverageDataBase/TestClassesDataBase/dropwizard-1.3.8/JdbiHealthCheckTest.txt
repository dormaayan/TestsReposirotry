public class JdbiHealthCheckTest {
  private static final String VALIDATION_QUERY="select 1";
  private Jdbi jdbi;
  private Handle handle;
  private ExecutorService executorService;
  private JdbiHealthCheck sut;
  @Before public void setup(){
    jdbi=mock(Jdbi.class);
    handle=mock(Handle.class);
    when(jdbi.open()).thenReturn(handle);
    executorService=Executors.newSingleThreadExecutor();
    sut=new JdbiHealthCheck(executorService,Duration.milliseconds(100),jdbi,VALIDATION_QUERY);
  }
  @After public void teardown(){
    executorService.shutdown();
  }
  @Test public void testNoTimeoutReturnsHealthy() throws Exception {
    when(handle.execute(VALIDATION_QUERY)).thenReturn(0);
    HealthCheck.Result result=sut.check();
    assertThat(result.isHealthy()).isTrue();
  }
  @Test public void testItTimesOutProperly() throws Exception {
    when(handle.execute(VALIDATION_QUERY)).thenAnswer((Answer<Integer>)invocation -> {
      TimeUnit.SECONDS.sleep(10);
      return null;
    }
);
    HealthCheck.Result result=sut.check();
    assertThat(result.isHealthy()).isFalse();
  }
}
